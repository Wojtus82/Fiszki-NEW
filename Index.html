<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fiszki WOJTUKIEWICZ - Color Logic</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: '#334155', light: '#475569', dark: '#1e293b' },
                        accent: { 
                            DEFAULT: 'rgb(var(--accent-main) / <alpha-value>)', 
                            light: 'rgb(var(--accent-light) / <alpha-value>)', 
                            dark: 'rgb(var(--accent-dark) / <alpha-value>)' 
                        },
                        paper: { light: '#f8fafc', dark: '#1e293b' }
                    },
                    boxShadow: {
                        'soft-xl': '0 20px 25px -5px rgb(0 0 0 / 0.05), 0 8px 10px -6px rgb(0 0 0 / 0.01)',
                    },
                    animation: {
                        'slide-in-right': 'slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --accent-main: 13 148 136;  
            --accent-light: 20 184 166; 
            --accent-dark: 15 118 110;  
        }

        body {
            background: radial-gradient(circle at top center, #f1f5f9, #cbd5e1);
            min-height: 100dvh;
        }
        .dark body {
            background: radial-gradient(circle at top center, #1e293b, #0f172a);
        }

        .glass-panel {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass-panel {
            background-color: rgba(30, 41, 59, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .tactile-button {
            transition: all 0.2s ease;
            box-shadow: 0 3px 5px -1px rgb(0 0 0 / 0.1), 0 2px 3px -2px rgb(0 0 0 / 0.1), inset 0 1px 1px rgba(255,255,255,0.2);
        }
        .tactile-button:active {
            transform: scale(0.97);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05), inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-3d-look {
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.15), 0 8px 10px -6px rgb(0 0 0 / 0.1), inset 0 1px 0 rgba(255,255,255, 0.3), 0 4px 0 rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .dark .card-3d-look {
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.3), inset 0 1px 0 rgba(255,255,255, 0.1), 0 4px 0 rgba(0,0,0,0.3);
        }

        .control-3d {
            transition: all 0.15s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), inset 0 1px 0 rgba(255,255,255, 0.4), 0 3px 0 rgba(0,0,0,0.1);
            transform: translateY(0);
        }
        .dark .control-3d {
             box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2), inset 0 1px 0 rgba(255,255,255, 0.1), 0 3px 0 rgba(0,0,0,0.3);
        }
        .control-3d:active {
            transform: translateY(3px);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05), inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-popIn { animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .animate-slideIn { animation: fadeIn 0.3s ease-out; }

        @keyframes spinThreeTimes { 0% { transform: rotate(0deg); } 100% { transform: rotate(1080deg); } }
        .animate-spin-three { animation: spinThreeTimes 3s ease-in-out; }

        @keyframes startUpShake {
            0% { transform: scale(1) rotate(0deg); } 15% { transform: scale(1.6) rotate(-25deg); } 30% { transform: scale(2.2) rotate(25deg); } 45% { transform: scale(1.6) rotate(-25deg); } 60% { transform: scale(1.2) rotate(25deg); } 75% { transform: scale(1.1) rotate(-10deg); } 100% { transform: scale(1) rotate(0deg); }
        }
        .startup-anim { display: inline-block; transform-origin: center center; animation: startUpShake 1.5s ease-in-out 2; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        
        #error-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.98); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: #991b1b; padding: 20px; text-align: center; }
        .no-tap-highlight { -webkit-tap-highlight-color: transparent; }
        .noselect { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }

        .item-multi-selected {
            background-color: rgb(var(--accent-main) / 0.1) !important;
            border-color: rgb(var(--accent-main)) !important;
            color: rgb(var(--accent-dark)) !important;
            box-shadow: inset 0 0 0 1px rgb(var(--accent-main));
        }
        .dark .item-multi-selected {
            background-color: rgb(var(--accent-main) / 0.2) !important;
            border-color: rgb(var(--accent-light)) !important;
            color: rgb(var(--accent-light)) !important;
        }

        /* Styl dla suwaka (Range Input) */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: rgb(var(--accent-main));
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }
        .dark input[type=range]::-webkit-slider-runnable-track {
            background: #475569;
        }

        @keyframes cardShake {
            0% { transform: translate(0, 0) rotate(0deg); } 10% { transform: translate(-3px, -2px) rotate(-1deg); } 20% { transform: translate(3px, 2px) rotate(1deg); } 30% { transform: translate(-3px, 2px) rotate(0deg); } 40% { transform: translate(3px, -2px) rotate(1deg); } 50% { transform: translate(-2px, 2px) rotate(-1deg); } 60% { transform: translate(2px, -2px) rotate(0deg); } 70% { transform: translate(-2px, 1px) rotate(1deg); } 80% { transform: translate(2px, -1px) rotate(-1deg); } 90% { transform: translate(-1px, 2px) rotate(0deg); } 100% { transform: translate(0, 0) rotate(0deg); }
        }
        .animate-card-shake { animation: cardShake 0.4s ease-in-out infinite; }
    </style>
</head>
<body class="m-0 text-slate-700 dark:text-slate-200 no-tap-highlight overflow-hidden transition-colors duration-500">

    <div id="error-overlay">
        <h2 class="text-2xl font-bold mb-2">Wystąpił błąd</h2>
        <p class="mb-4 text-gray-600">Nie udało się załadować bazy danych Excel.</p>
        <div id="local-file-warning" class="hidden mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm max-w-md text-left">
            <strong>⚠️ Wykryto uruchomienie lokalne (file://)</strong><br/><br/>
            Przeglądarki mogą blokować wczytywanie pliku <code>bazaA1.xlsx</code> z dysku ze względów bezpieczeństwa (CORS).<br/>
            Aby to działało lokalnie, najlepiej uruchomić prosty serwer (np. Live Server w VS Code).
        </div>
        <pre id="error-message" class="bg-red-100 p-4 rounded text-sm text-left overflow-auto max-w-full max-h-64 select-text"></pre>
        <button onclick="location.reload()" class="bg-red-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 transition mt-4">Spróbuj ponownie</button>
    </div>

    <div id="root"></div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-overlay').style.display = 'flex';
            document.getElementById('error-message').textContent = `JS Error: ${msg}\nLine: ${line}`;
            if (window.location.protocol === 'file:') {
                document.getElementById('local-file-warning').style.display = 'block';
            }
            return false;
        };
    </script>

    <script type="text/babel">
        try {
            const { useState, useEffect, useMemo, useRef } = React;

            const getStorage = (key, defaultValue) => {
                try {
                    const saved = localStorage.getItem(key);
                    if (saved === null) return defaultValue;
                    return JSON.parse(saved);
                } catch (e) {
                    console.warn("Błąd odczytu localStorage dla klucza:", key);
                    return defaultValue;
                }
            };

            const setStorage = (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.warn("Błąd zapisu localStorage:", key);
                }
            };

            const Icon = ({ path, size = 24, className="" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
            );

            const iconPaths = {
                layers: <><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>,
                book: <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>,
                rotate: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>,
                left: <><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>,
                right: <><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>,
                vol: <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></>,
                volX: <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></>,
                tag: <><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></>,
                clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                moon: <><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></>,
                sun: <><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>,
                close: <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>,
                trophy: <><path d="M8 21h8"/><path d="M12 17v4"/><path d="M7 4h10"/><path d="M17 4v8a5 5 0 0 1-10 0V4"/><path d="M5 9v1a2 2 0 0 0 2 2"/><path d="M19 9v1a2 2 0 0 1-2 2"/></>,
                reloadCustom: <><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></>,
                play: <polygon points="5 3 19 12 5 21 5 3" fill="currentColor"/>,
                pause: <><rect x="6" y="4" width="4" height="16" fill="currentColor" /><rect x="14" y="4" width="4" height="16" fill="currentColor" /></>,
                swap: <><path d="M7 16V4M7 4L3 8M7 4L11 8"/><path d="M17 8v12M17 20l4-4M17 20l-4-4"/></>,
                check: <polyline points="20 6 9 17 4 12"></polyline>,
                filter: <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>,
                square: <rect x="3" y="3" width="18" height="18" rx="3.5" ry="3.5"></rect>,
                checkSquare: <><rect x="3" y="3" width="18" height="18" rx="3.5" ry="3.5"></rect><polyline points="9 11 12 14 22 4"></polyline></>,
                barChart: <><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></>,
                runningMan: <>
                    <circle cx="18" cy="5" r="2" fill="currentColor" />
                    <path d="M14.5 9.5L12 17l4 3" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round" />
                    <path d="M14.5 9.5l3.5 3l3-1" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round" />
                    <path d="M14.5 9.5l-2-2-4 1" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round" />
                    <path d="M12 17l-3 2l-2-1" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round" />
                    <path d="M3 13h5M2 17h4M4 9h5" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" />
                </>,
                infoCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>,
                fileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></>,
                menu: <><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></>,
                settings: <><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></>,
                reset: <><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>,
                rabbit: <><path d="M12 2c-3.5 0-6.5 2-8 5 3 0 6-1 8-5z"/><path d="M12 2c3.5 0 6.5 2 8 5-3 0-6-1-8-5z"/><circle cx="12" cy="14" r="8"/><circle cx="12" cy="14" r="3" fill="currentColor" opacity="0.3"/></>,
                autoPlay: <><polygon points="5 3 19 12 5 21 5 3"></polygon><path d="M2 2v20"></path></>
            };

            const themeColors = {
                teal:   { main: '13 148 136', light: '20 184 166', dark: '15 118 110', name: 'Domyślny' },
                blue:   { main: '37 99 235',  light: '59 130 246', dark: '29 78 216', name: 'Niebieski' },
                green:  { main: '22 163 74',  light: '34 197 94',  dark: '21 128 61', name: 'Zielony' },
                pink:   { main: '219 39 119', light: '236 72 153', dark: '190 24 93', name: 'Różowy' },
                orange: { main: '249 115 22', light: '251 146 60', dark: '234 88 12', name: 'Pomarańczowy' },
                gray:   { main: '100 116 139', light: '148 163 184', dark: '71 85 105', name: 'Szary' }
            };

            const parseSentenceRow = (text) => {
                if (!text) return null;
                const str = String(text); 
                const lastParenIndex = str.lastIndexOf('(');
                if (lastParenIndex === -1) return { en: str.trim(), pl: '' };
                const en = str.substring(0, lastParenIndex).trim();
                const pl = str.substring(lastParenIndex + 1, str.length - 1).trim(); 
                return { en, pl };
            };

            const extractSentencesFromCell = (cellContent, isBeginner = false) => {
                if (!cellContent) return [];
                let strContent = String(cellContent);

                if (isBeginner) {
                    strContent = strContent.replace(/(\r\n|\n|\r)/gm, " ");
                    strContent = strContent.replace(/([0-9]+\.)/g, "\n$1");
                    const lines = strContent.split('\n');
                    return lines
                        .map(line => line.trim())
                        .filter(line => line.length > 0)
                        .map(line => ({ en: line, pl: '' })); 
                } else {
                    strContent = strContent.trim();
                    strContent = strContent.replace(/(?:^|\s+)([1-5]\.)\s*/g, '\n$1 ');
                    strContent = strContent.replace(/\)/g, ')\n');
                    
                    const lines = strContent.split(/\r?\n/).filter(line => line.trim() !== "");
                    return lines.map(line => parseSentenceRow(line)).filter(s => s && s.en);
                }
            };

            const getWordSizeClass = (text) => {
                if (!text) return "text-5xl sm:text-7xl";
                const len = text.length;
                if (len < 12) return "text-5xl sm:text-7xl"; 
                if (len < 20) return "text-4xl sm:text-6xl"; 
                if (len < 30) return "text-3xl sm:text-5xl"; 
                return "text-xl sm:text-3xl"; 
            };

            const getTranslationSizeClass = (text) => {
                if (!text) return "text-5xl sm:text-6xl";
                const len = text.length;
                if (len < 15) return "text-5xl sm:text-6xl"; 
                if (len < 30) return "text-3xl sm:text-5xl"; 
                if (len < 50) return "text-2xl sm:text-3xl"; 
                return "text-lg sm:text-xl"; 
            };
            
            const getPhoneticSizeClass = (text) => {
                if (!text) return "text-3xl sm:text-4xl";
                const len = text.length;
                if (len < 20) return "text-3xl sm:text-4xl";
                return "text-xl sm:text-2xl";
            };

            function FlashcardsApp() {
                const [fullDatabase, setFullDatabase] = useState([]);
                const [grammarData, setGrammarData] = useState({});
                const [loading, setLoading] = useState(true);
                const [fileError, setFileError] = useState(null);

                const [selectedLevels, setSelectedLevels] = useState(() => getStorage('fc-levels', ['A1'])); 
                const [isLevelModalOpen, setIsLevelModalOpen] = useState(false);
                const [tempSelectedLevels, setTempSelectedLevels] = useState([]);
                const availableLevels = ['A1', 'A2', 'B1', 'B2'];

                const [selectedCategories, setSelectedCategories] = useState(() => getStorage('fc-cats', [])); 
                const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);
                const [tempSelectedCategories, setTempSelectedCategories] = useState([]); 
                
                const [tense, setTense] = useState(() => getStorage('fc-tense', 'Base'));
                
                const [availableCategories, setAvailableCategories] = useState([]);
                const [currentWordIds, setCurrentWordIds] = useState([]);
                const [currentIndex, setCurrentIndex] = useState(0);
                const [isFinished, setIsFinished] = useState(false);
                
                const [cardSide, setCardSide] = useState(1);
                const [prevCardSide, setPrevCardSide] = useState(1);
                
                const [rotationX, setRotationX] = useState(0);
                const [rotation, setRotation] = useState(0);
                const [noTransition, setNoTransition] = useState(false);
                
                const [isSpeaking, setIsSpeaking] = useState(false);
                const [isPaused, setIsPaused] = useState(false);

                const [isShuffling, setIsShuffling] = useState(false);

                const [isPlToEn, setIsPlToEn] = useState(() => getStorage('fc-plEn', false));

                const [isDarkMode, setIsDarkMode] = useState(() => {
                    const savedTheme = localStorage.getItem('flashcards-theme');
                    return savedTheme === 'dark';
                });

                const [isMenuOpen, setIsMenuOpen] = useState(false);
                const [voiceVariant, setVoiceVariant] = useState(() => getStorage('fc-voice', 'US')); 
                const [themeColor, setThemeColor] = useState(() => getStorage('fc-color', 'teal'));
                
                // --- NEW FEATURES STATES ---
                const [speechRate, setSpeechRate] = useState(() => getStorage('fc-rate', 1.0));
                const [autoPlay, setAutoPlay] = useState(() => getStorage('fc-autoplay', false));

                const [isStartAnimating, setIsStartAnimating] = useState(false);
                const [oledMode, setOledMode] = useState(false);

                const [viewAllSentences, setViewAllSentences] = useState(false);
                const [activeSentenceIndex, setActiveSentenceIndex] = useState(null);
                
                const [speakingSentenceIndex, setSpeakingSentenceIndex] = useState(0);
                const [pauseDuration, setPauseDuration] = useState(() => getStorage('fc-pause', 0));

                const [voices, setVoices] = useState([]);
                const [selectedVoice, setSelectedVoice] = useState(null);
                const [selectedPlVoice, setSelectedPlVoice] = useState(null);

                const [touchStart, setTouchStart] = useState(null); 
                const [touchEnd, setTouchEnd] = useState(null);
                const minSwipeDistance = 50;

                const wakeLockRef = useRef(null);
                const itemRefs = useRef([]); 
                
                const queueRef = useRef([]);
                const queueIndexRef = useRef(0);
                const pausedIntentionally = useRef(false);
                const isPausedRef = useRef(false);
                
                const lastTapRef = useRef(0);
                const tapCountRef = useRef(0);

                useEffect(() => {
                    const t = themeColors[themeColor] || themeColors.teal;
                    document.documentElement.style.setProperty('--accent-main', t.main);
                    document.documentElement.style.setProperty('--accent-light', t.light);
                    document.documentElement.style.setProperty('--accent-dark', t.dark);
                    setStorage('fc-color', themeColor);
                }, [themeColor]);

                useEffect(() => {
                    localStorage.setItem('flashcards-theme', isDarkMode ? 'dark' : 'light');
                    if (isDarkMode) document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                }, [isDarkMode]);

                useEffect(() => { setStorage('fc-levels', selectedLevels); }, [selectedLevels]);
                useEffect(() => { setStorage('fc-cats', selectedCategories); }, [selectedCategories]);
                useEffect(() => { setStorage('fc-tense', tense); }, [tense]);
                useEffect(() => { setStorage('fc-plEn', isPlToEn); }, [isPlToEn]);
                useEffect(() => { setStorage('fc-pause', pauseDuration); }, [pauseDuration]);
                useEffect(() => { setStorage('fc-voice', voiceVariant); }, [voiceVariant]);
                useEffect(() => { setStorage('fc-rate', speechRate); }, [speechRate]);
                useEffect(() => { setStorage('fc-autoplay', autoPlay); }, [autoPlay]);

                useEffect(() => {
                    const startTimer = setTimeout(() => {
                        setIsStartAnimating(true);
                        const endTimer = setTimeout(() => {
                            setIsStartAnimating(false);
                        }, 3000); 
                        return () => clearTimeout(endTimer);
                    }, 3000);
                    return () => clearTimeout(startTimer);
                }, []);

                useEffect(() => {
                    const loadVoices = () => {
                        const availableVoices = window.speechSynthesis.getVoices();
                        setVoices(availableVoices);
                    };
                    loadVoices();
                    if (window.speechSynthesis.onvoiceschanged !== undefined) {
                        window.speechSynthesis.onvoiceschanged = loadVoices;
                    }
                }, []);

                useEffect(() => {
                    if (voices.length === 0) return;

                    const findSpecificVoice = (targetLangPrefix, variant) => {
                        const allLangVoices = voices.filter(v => v.lang.startsWith(targetLangPrefix));

                        let regionVoices = [];
                        
                        if (targetLangPrefix === 'en') {
                            if (variant === 'GB') {
                                regionVoices = allLangVoices.filter(v => 
                                    v.lang.replace('_', '-').toLowerCase().includes('gb') || 
                                    v.lang.replace('_', '-').toLowerCase().includes('uk') || 
                                    v.name.includes('UK') || 
                                    v.name.includes('Great Britain') ||
                                    v.name.includes('United Kingdom')
                                );
                            } else {
                                regionVoices = allLangVoices.filter(v => 
                                    v.lang.replace('_', '-').toLowerCase().includes('us') || 
                                    v.name.includes('United States')
                                );
                            }
                        } else {
                            regionVoices = allLangVoices;
                        }

                        if (regionVoices.length === 0) regionVoices = allLangVoices;

                        const premiumVoice = regionVoices.find(v => 
                            v.name.includes("Google") || 
                            v.name.includes("Natural") || 
                            v.name.includes("Online") || 
                            v.name.includes("Premium") || 
                            v.name.includes("Enhanced")
                        );

                        if (premiumVoice) return premiumVoice;

                        const preferredNames = variant === 'GB' 
                            ? ['Daniel', 'Arthur', 'Martha', 'Amy'] 
                            : ['Samantha', 'Karen', 'Rishi', 'Moira']; 

                        const nameMatch = regionVoices.find(v => preferredNames.some(name => v.name.includes(name)));
                        if (nameMatch) return nameMatch;

                        return regionVoices[0];
                    };

                    const bestEn = findSpecificVoice('en', voiceVariant);
                    if (bestEn) setSelectedVoice(bestEn);

                    const bestPl = findSpecificVoice('pl', null);
                    if (bestPl) setSelectedPlVoice(bestPl);

                }, [voices, voiceVariant]);

                const getColumnValue = (row, colName) => {
                    if (!row) return undefined;
                    const keys = Object.keys(row);
                    const target = String(colName).trim().toLowerCase();
                    const matchingKey = keys.find(k => String(k).trim().toLowerCase() === target);
                    return matchingKey ? row[matchingKey] : undefined;
                };

                useEffect(() => {
                    setLoading(true);
                    const excelUrl = `bazaA1.xlsx?t=${new Date().getTime()}`;
                    
                    fetch(excelUrl)
                        .then(res => {
                            if (!res.ok) throw new Error(`Błąd sieci: ${res.status} ${res.statusText}`);
                            return res.arrayBuffer();
                        })
                        .then(ab => {
                            const workbook = XLSX.read(ab, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                            if (jsonData && jsonData.length > 0) {
                                const tenseColumns = [
                                    "Beginner", "Present Simple", "Present continuous", "Past Simple", 
                                    "Future Simple", "Present Perfect", "Past Continuous", "Going To",
                                    "Questions"
                                ];

                                const foundGrammar = {};
                                const allTensesToCheck = ['Base', ...tenseColumns];

                                allTensesToCheck.forEach(tenseName => {
                                    const colHeader = `${tenseName}_info`;
                                    const foundRow = jsonData.find(row => {
                                        const val = getColumnValue(row, colHeader);
                                        return val && String(val).trim().length > 0;
                                    });
                                    if (foundRow) foundGrammar[tenseName] = String(getColumnValue(foundRow, colHeader)).trim();
                                });
                                setGrammarData(foundGrammar);

                                const processedData = [];
                                jsonData.forEach(row => {
                                    const id = row.id;
                                    const rawLevel = row.level ? String(row.level).trim() : "A1";
                                    const rawCat = row.category ? String(row.category).trim() : "Inne";
                                    const word = row.word ? String(row.word).trim() : "";
                                    const translation = row.translation ? String(row.translation).trim() : "";
                                    const phonetic = row.phonetic ? String(row.phonetic).trim() : "";
                                    const wordInfo = row.word_info ? String(row.word_info).trim() : "";

                                    const baseSentences = extractSentencesFromCell(row.base);
                                    processedData.push({
                                        id: id, level: rawLevel, category: rawCat, word: word, translation: translation,
                                        phonetic: phonetic, tense: 'Base', sentencesList: baseSentences,
                                        wordInfo: wordInfo
                                    });

                                    tenseColumns.forEach(tenseName => {
                                        const cellVal = getColumnValue(row, tenseName);
                                        if (cellVal) {
                                            const isBeginner = tenseName === "Beginner" || tenseName === "Początkujący";
                                            const tenseSentences = extractSentencesFromCell(cellVal, isBeginner);
                                            if (tenseSentences.length > 0) {
                                                processedData.push({
                                                    id: id, level: rawLevel, category: rawCat, word: word, translation: translation,
                                                    phonetic: phonetic, tense: tenseName, sentencesList: tenseSentences,
                                                    wordInfo: wordInfo 
                                                });
                                            }
                                        }
                                    });
                                });
                                setFullDatabase(processedData);
                                setLoading(false);
                            } else {
                                setFileError("Plik Excel wygląda na pusty.");
                                setLoading(false);
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            setFileError(`Błąd wczytywania Excela: ${err.message}. Upewnij się, że plik 'bazaA1.xlsx' jest w tym samym folderze.`);
                            setLoading(false);
                        });
                }, []);

                useEffect(() => {
                    if (!fullDatabase.length) { setAvailableCategories([]); return; }
                    const filteredRows = fullDatabase.filter(row => selectedLevels.includes(row.level));
                    const cats = [...new Set(filteredRows.map(row => row.category))].sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
                    setAvailableCategories(cats);
                    setSelectedCategories(prevCats => prevCats.filter(cat => cats.includes(cat)));
                }, [selectedLevels, fullDatabase]);

                useEffect(() => {
                    if (!fullDatabase.length) return;
                    setIsShuffling(true);
                    const uniqueIds = [...new Set(fullDatabase.filter(row => {
                        const levelMatch = selectedLevels.includes(row.level);
                        const catMatch = selectedCategories.length === 0 ? true : selectedCategories.includes(row.category);
                        return levelMatch && catMatch;
                    }).map(row => row.id))];
                    
                    const shuffledIds = [...uniqueIds].sort(() => Math.random() - 0.5);
                    setCurrentWordIds(shuffledIds);
                    setCurrentIndex(0);
                    setIsFinished(false);
                    resetCard();
                    const timer = setTimeout(() => { setIsShuffling(false); }, 1500);
                    return () => clearTimeout(timer);
                }, [selectedCategories, selectedLevels, fullDatabase]);

                // --- AUTOPLAY LOGIC ---
                useEffect(() => {
                    if (autoPlay && !isFinished && !loading && currentWordIds.length > 0 && !isShuffling) {
                        // Wait for card animation
                        const timer = setTimeout(() => {
                            handleSpeak();
                        }, 600);
                        return () => clearTimeout(timer);
                    }
                }, [currentIndex, isFinished, autoPlay, isShuffling]);

                const handleFactoryReset = () => {
                    if (confirm("Czy na pewno chcesz przywrócić ustawienia domyślne? Wszystkie Twoje preferencje zostaną skasowane.")) {
                        localStorage.clear();
                        location.reload();
                    }
                };

                const openCategoryModal = () => { setTempSelectedCategories([...selectedCategories]); setIsCategoryModalOpen(true); };
                const closeCategoryModal = () => setIsCategoryModalOpen(false);
                const handleSingleSelectCategory = (cat) => { setSelectedCategories([cat]); setTempSelectedCategories([cat]); closeCategoryModal(); };
                const handleMultiToggleCategory = (e, cat) => { e.stopPropagation(); setTempSelectedCategories(prev => { if (prev.includes(cat)) return prev.filter(c => c !== cat); return [...prev, cat]; }); };
                const confirmMultiCategorySelection = () => { setSelectedCategories([...tempSelectedCategories]); closeCategoryModal(); };
                const getCategoryLabel = () => { if (selectedCategories.length === 0) return "Wszystkie"; if (selectedCategories.length === 1) return selectedCategories[0]; return `${selectedCategories.length} wybrane`; };

                const openLevelModal = () => { setTempSelectedLevels([...selectedLevels]); setIsLevelModalOpen(true); };
                const closeLevelModal = () => setIsLevelModalOpen(false);
                const handleSingleSelectLevel = (lvl) => { setSelectedLevels([lvl]); setTempSelectedLevels([lvl]); closeLevelModal(); };
                const handleMultiToggleLevel = (e, lvl) => { e.stopPropagation(); setTempSelectedLevels(prev => { if (prev.includes(lvl)) return prev.filter(l => l !== lvl); return [...prev, lvl]; }); };
                const confirmMultiLevelSelection = () => { if (tempSelectedLevels.length === 0) { alert("Musisz wybrać przynajmniej jeden poziom."); return; } setSelectedLevels([...tempSelectedLevels]); closeLevelModal(); };
                const getLevelLabel = () => { if (selectedLevels.length === 0) return "Brak"; if (selectedLevels.length === 1) return selectedLevels[0]; return `${selectedLevels.length} wybrane`; };

                const availableTenses = useMemo(() => {
                        if (!currentWordIds.length || !fullDatabase.length) return [];
                        const currentId = currentWordIds[currentIndex];
                        const rows = fullDatabase.filter(row => row.id === currentId && selectedLevels.includes(row.level) && (selectedCategories.length === 0 || selectedCategories.includes(row.category)));
                        const tenses = rows.map(r => r.tense).filter(t => t && t !== 'Base');
                        return [...new Set(tenses)];
                }, [currentWordIds, currentIndex, fullDatabase, selectedLevels, selectedCategories]);

                const allCategorySentences = useMemo(() => {
                    if (!viewAllSentences) return [];
                    if (!fullDatabase.length) return [];
                    if (!currentWordIds.length) return [];
                    let sentences = [];
                    currentWordIds.forEach((id, idx) => {
                        const wordRows = fullDatabase.filter(row => row.id === id && selectedLevels.includes(row.level) && (selectedCategories.length === 0 || selectedCategories.includes(row.category)));
                        let rowsToProcess = [];
                        if (tense === 'mixed') rowsToProcess = wordRows.filter(r => r.tense !== 'Base'); else rowsToProcess = wordRows.filter(r => r.tense === tense);
                        rowsToProcess.forEach(row => { if (row.sentencesList && row.sentencesList.length > 0) { row.sentencesList.forEach(s => { sentences.push({ ...s, word: row.word, wordIndex: idx, phonetic: row.phonetic }); }); } });
                    });
                    return sentences;
                }, [viewAllSentences, currentWordIds, fullDatabase, tense, selectedLevels, selectedCategories]);

                useEffect(() => { itemRefs.current = []; setSpeakingSentenceIndex(0); }, [allCategorySentences, viewAllSentences]);

                const getDisplayData = () => {
                    if (!fullDatabase.length) return null;
                    if (!currentWordIds.length) return { isEmpty: true, word: "Brak słówek", translation: "Zmień filtry", phonetic: "---", sentences: [], wordInfo: "" };
                    const currentId = currentWordIds[currentIndex];
                    const validRows = fullDatabase.filter(row => row.id === currentId && selectedLevels.includes(row.level) && (selectedCategories.length === 0 || selectedCategories.includes(row.category)));
                    const baseRow = validRows.find(row => row.tense === 'Base');
                    const fallbackRow = validRows[0]; 
                    const mainInfoRow = baseRow || fallbackRow;
                    if (!mainInfoRow) return null;
                    let sentences = [];
                    if (tense === 'mixed') { const allVariations = validRows.filter(row => row.tense !== 'Base'); allVariations.forEach(row => { if (row.sentencesList) sentences.push(...row.sentencesList); }); sentences = sentences.sort(() => Math.random() - 0.5).slice(0, 5); } else if (tense === 'Base') { if (baseRow && baseRow.sentencesList) sentences = baseRow.sentencesList; } else { const activeRow = validRows.find(row => row.tense === tense); if (activeRow && activeRow.sentencesList) sentences = activeRow.sentencesList; }
                    const t = (tense === 'mixed') ? 'Base' : tense;
                    const infoText = grammarData[t] || "";
                    return { word: mainInfoRow.word, translation: mainInfoRow.translation, phonetic: mainInfoRow.phonetic, sentences: sentences, infoText: infoText, wordInfo: mainInfoRow.wordInfo };
                };

                const displayData = getDisplayData();
                const sentencesListToRender = viewAllSentences ? allCategorySentences : (displayData ? displayData.sentences : []);

                const currentPhoneticToDisplay = useMemo(() => {
                    if (viewAllSentences) { if (activeSentenceIndex !== null && sentencesListToRender[activeSentenceIndex]) { return sentencesListToRender[activeSentenceIndex].phonetic; } if (sentencesListToRender[speakingSentenceIndex]) { return sentencesListToRender[speakingSentenceIndex].phonetic; } }
                    return displayData ? displayData.phonetic : "";
                }, [viewAllSentences, activeSentenceIndex, speakingSentenceIndex, sentencesListToRender, displayData]);

                const handleStart = (clientX, clientY) => { setTouchEnd(null); setTouchStart({ x: clientX, y: clientY }); };
                const handleMove = (clientX, clientY) => { setTouchEnd({ x: clientX, y: clientY }); };
                const handleEnd = () => { if (!touchStart || !touchEnd) return; const distanceX = touchStart.x - touchEnd.x; const distanceY = touchStart.y - touchEnd.y; if (Math.abs(distanceY) > Math.abs(distanceX)) { setTouchStart(null); setTouchEnd(null); return; } if (distanceX > minSwipeDistance) handleNext(); else if (distanceX < -minSwipeDistance) handlePrev(); setTouchStart(null); setTouchEnd(null); };
                const onTouchStart = (e) => handleStart(e.targetTouches[0].clientX, e.targetTouches[0].clientY);
                const onTouchMove = (e) => handleMove(e.targetTouches[0].clientX, e.targetTouches[0].clientY);
                const onTouchEnd = () => handleEnd();
                const onMouseDown = (e) => handleStart(e.clientX, e.clientY);
                const onMouseMove = (e) => { if(touchStart) handleMove(e.clientX, e.clientY); };
                const onMouseUp = () => { handleEnd(); };
                const onMouseLeave = () => { setTouchStart(null); setTouchEnd(null); };

                const handleTripleTap = (callback) => { const now = new Date().getTime(); const timeDiff = now - lastTapRef.current; if (timeDiff < 400 && timeDiff > 0) { tapCountRef.current++; } else { tapCountRef.current = 1; } lastTapRef.current = now; if (tapCountRef.current === 3) { callback(); tapCountRef.current = 0; } };
                const requestWakeLock = async () => { if ('wakeLock' in navigator) { try { const lock = await navigator.wakeLock.request('screen'); wakeLockRef.current = lock; } catch (err) { console.log("Wake Lock error:", err); } } };
                const releaseWakeLock = async () => { if (wakeLockRef.current) { try { await wakeLockRef.current.release(); wakeLockRef.current = null; } catch(err) {} } };

                const resetCard = () => { setNoTransition(true); setPrevCardSide(cardSide); setCardSide(1); setRotation(0); setRotationX(0); cancelSpeech(); setViewAllSentences(false); setTimeout(() => setNoTransition(false), 50); };
                const handleNext = () => { if (!currentWordIds.length || isFinished) return; setViewAllSentences(false); cancelSpeech(); if (currentIndex >= currentWordIds.length - 1) { setIsFinished(true); setNoTransition(true); setPrevCardSide(cardSide); setCardSide(1); setRotation(0); setRotationX(0); return; } setNoTransition(true); setPrevCardSide(cardSide); setCardSide(1); setRotation(0); setRotationX(0); setTimeout(() => { setNoTransition(false); setCurrentIndex((prev) => prev + 1); }, 50); };
                const handlePrev = () => { if (!currentWordIds.length || isFinished) return; setViewAllSentences(false); cancelSpeech(); setNoTransition(true); setPrevCardSide(cardSide); setCardSide(1); setRotation(0); setRotationX(0); setTimeout(() => { setNoTransition(false); setCurrentIndex((prev) => (prev - 1 + currentWordIds.length) % currentWordIds.length); }, 50); };
                const handleReset = () => { setIsFinished(false); setCurrentIndex(0); resetCard(); };

                const handleCardClick = () => { if (isFinished || (displayData && displayData.isEmpty)) return; cancelSpeech(); if (cardSide === 1) { setPrevCardSide(1); setCardSide(2); setRotation(180); setRotationX(0); } else if (cardSide === 2) { setPrevCardSide(2); setCardSide(1); setRotation(0); setRotationX(0); } else if (cardSide === 3) { showTranslation(); } else if (cardSide === 4) { showSentences(); } else if (cardSide === 5) { showTranslation(); } };
                const showSentences = (e) => { if(e) e.stopPropagation(); cancelSpeech(); setPrevCardSide(cardSide); setCardSide(3); setRotation(360); setRotationX(0); };
                const showTranslation = (e) => { if(e) e.stopPropagation(); cancelSpeech(); setPrevCardSide(cardSide); setCardSide(2); setRotation(180); setRotationX(0); setViewAllSentences(false); };
                const showGrammarInfo = (e) => { if(e) e.stopPropagation(); cancelSpeech(); setPrevCardSide(cardSide); setCardSide(4); setRotation(360); setRotationX(180); };
                const showBeginnerInfo = (e) => { if(e) e.stopPropagation(); cancelSpeech(); setPrevCardSide(cardSide); setCardSide(5); setRotation(180); setRotationX(180); };
                const togglePauseDuration = (e) => { e.stopPropagation(); setPauseDuration(prev => { if (prev >= 2) return -2; return prev + 1; }); };

                const handleSpeak = (resume = false) => {
                    if (isFinished || !displayData || displayData.isEmpty) return;
                    
                    window.speechSynthesis.cancel();
                    requestWakeLock();
                    
                    setIsSpeaking(true);
                    setIsPaused(false);
                    pausedIntentionally.current = false;
                    
                    const cleanSentence = (txt) => txt.replace(/^\s*[0-9]+\.\s*/g, '').trim();
                    
                    const isMixedLangMode = tense === 'Początkujący' || tense === 'Beginner';
                    const targetWord = displayData.word ? displayData.word.split('(')[0].trim() : "";

                    const targetEnLang = voiceVariant === 'GB' ? 'en-GB' : 'en-US';

                    let fullQueue = [];
                    
                    if (resume && queueRef.current.length > 0) {
                        fullQueue = queueRef.current;
                    } else {
                        if (viewAllSentences) setSpeakingSentenceIndex(0);
                        
                        let tempQueue = [];

                        const pushMixedSentence = (rawText, vIndex, gIndex) => {
                            let text = cleanSentence(rawText);
                            text = text.replace(/\.$/, ''); 

                            if (!targetWord || !isMixedLangMode) {
                                tempQueue.push({ 
                                    text: text, 
                                    isSentence: true, 
                                    visualIndex: vIndex, 
                                    globalIndex: gIndex,
                                    lang: isMixedLangMode ? 'pl-PL' : targetEnLang 
                                });
                            } else {
                                const escapedTarget = targetWord.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                                const regex = new RegExp(`(${escapedTarget})`, 'gi');
                                const parts = text.split(regex);

                                parts.forEach(part => {
                                    if (!part.trim()) return;
                                    if (/^[.,?!]+$/.test(part.trim())) return;

                                    const isEnWord = part.toLowerCase() === targetWord.toLowerCase();
                                    tempQueue.push({
                                        text: part,
                                        isSentence: true, 
                                        visualIndex: vIndex, 
                                        globalIndex: gIndex,
                                        lang: isEnWord ? targetEnLang : 'pl-PL', 
                                        forceVoice: isEnWord ? selectedVoice : selectedPlVoice
                                    });
                                });
                            }
                        };

                        if (cardSide === 3 && viewAllSentences) {
                            let lastWord = "";
                            sentencesListToRender.forEach((s, index) => {
                                if (s.word !== lastWord) {
                                    if (lastWord !== "") tempQueue.push({ text: "...", isPause: true, customLevel: pauseDuration }); 
                                    lastWord = s.word;
                                    tempQueue.push({ text: lastWord, isWord: true, globalIndex: index, lang: targetEnLang });
                                    tempQueue.push({ text: ".", isPause: true, customLevel: pauseDuration }); 
                                }
                                const rowTargetWord = s.word ? s.word.split('(')[0].trim() : "";
                                if (isMixedLangMode && rowTargetWord) {
                                    pushMixedSentence(s.en, index, index);
                                } else {
                                    pushMixedSentence(s.en, index, index);
                                }
                                tempQueue.push({ text: "...", isPause: true, customLevel: pauseDuration });
                            });

                        } else if (cardSide === 3) {
                            displayData.sentences.forEach((s, index) => {
                                pushMixedSentence(s.en, index);
                                tempQueue.push({ text: "...", isPause: true, customLevel: pauseDuration });
                            });
                        } else if (cardSide === 5) {
                            if (displayData.wordInfo) {
                                tempQueue.push({ text: displayData.wordInfo, lang: targetEnLang }); 
                            }
                        } else {
                            tempQueue.push({ text: displayData.word, lang: targetEnLang });
                        }
                        fullQueue = tempQueue;
                        queueRef.current = tempQueue;
                        
                        if (!resume) queueIndexRef.current = 0;
                    }

                    if (fullQueue.length === 0) {
                        setIsSpeaking(false);
                        releaseWakeLock(); 
                        return;
                    }

                    const startIndex = resume ? queueIndexRef.current : 0;
                    const queueToSpeak = fullQueue.slice(startIndex);

                    if (queueToSpeak.length === 0) {
                        setIsSpeaking(false);
                        return;
                    }

                    queueToSpeak.forEach((item, i) => {
                        const u = new SpeechSynthesisUtterance(item.text);
                        
                        // USTAWIENIE PRĘDKOŚCI Z SUWAKA
                        u.rate = speechRate; 

                        if (item.forceVoice) {
                            u.voice = item.forceVoice;
                            u.lang = item.forceVoice.lang.startsWith('pl') ? 'pl-PL' : targetEnLang;
                        } else if (item.lang) {
                            u.lang = item.lang; 
                            if (item.lang.startsWith('pl') && selectedPlVoice) u.voice = selectedPlVoice;
                            if (item.lang.startsWith('en') && selectedVoice) {
                                u.voice = selectedVoice;
                                if (selectedVoice.lang && selectedVoice.lang.includes('GB')) u.lang = 'en-GB';
                                else if (selectedVoice.lang) u.lang = selectedVoice.lang;
                            }
                        } else {
                            if (isMixedLangMode) {
                                u.lang = 'pl-PL';
                                if (selectedPlVoice) u.voice = selectedPlVoice;
                            } else {
                                u.lang = targetEnLang;
                                if (selectedVoice) u.voice = selectedVoice;
                            }
                        }

                        if (item.isPause) {
                            u.volume = 0; 
                            let txt = " . . . ";
                            let r = 0.5;
                            if (item.customLevel === -2) { txt = " . . . . . . . . . . "; r = 0.1; } 
                            else if (item.customLevel === -1) { txt = " . . . . . . "; r = 0.3; } 
                            else if (item.customLevel === 0) { txt = " . . . "; r = 0.6; } 
                            else if (item.customLevel === 1) { txt = " . . "; r = 1.5; } 
                            else if (item.customLevel === 2) { txt = " . "; r = 3.0; } 
                            u.text = txt;
                            u.rate = r;
                        }
                        
                        if (u.lang.startsWith('en') && isMixedLangMode) { 
                             // Opcjonalnie: u.rate = speechRate * 0.8; 
                        }

                        u.onstart = () => {
                            if (isPausedRef.current) return;
                            const actualGlobalIndex = startIndex + i;
                            queueIndexRef.current = actualGlobalIndex;
                            if (i === 0) setIsSpeaking(true);
                            if (item.isSentence && item.visualIndex !== undefined) {
                                setActiveSentenceIndex(item.visualIndex); 
                                if (viewAllSentences && item.globalIndex !== undefined) { setSpeakingSentenceIndex(item.globalIndex); }
                                const element = itemRefs.current[item.visualIndex];
                                if (element) element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } else if (item.isWord) {
                                setActiveSentenceIndex(null); 
                                if (viewAllSentences && item.globalIndex !== undefined) { setSpeakingSentenceIndex(item.globalIndex); }
                            }
                        };

                        if (i === queueToSpeak.length - 1) {
                            u.onend = () => {
                                if (!pausedIntentionally.current) {
                                    setIsSpeaking(false);
                                    setIsPaused(false);
                                    setActiveSentenceIndex(null); 
                                    releaseWakeLock();
                                }
                            };
                            u.onerror = (e) => {
                                if (!pausedIntentionally.current) {
                                    console.error("Speech error", e);
                                    setIsSpeaking(false);
                                    setIsPaused(false);
                                    releaseWakeLock(); 
                                }
                            };
                        }
                        window.speechSynthesis.speak(u);
                    });
                };

                useEffect(() => {
                    if (isSpeaking && !isPaused) {
                        pausedIntentionally.current = true;
                        window.speechSynthesis.cancel();
                        queueRef.current = [];
                        handleSpeak(true);
                    }
                }, [pauseDuration, speechRate]);

                const cancelSpeech = () => { 
                    isPausedRef.current = false;
                    pausedIntentionally.current = false;
                    if (window.speechSynthesis) window.speechSynthesis.cancel(); 
                    setIsSpeaking(false);
                    setIsPaused(false);
                    setActiveSentenceIndex(null); 
                    releaseWakeLock(); 
                };

                const togglePlayPause = (e) => {
                    if(e) e.stopPropagation();
                    if (isSpeaking && !isPaused) {
                        isPausedRef.current = true;
                        pausedIntentionally.current = true;
                        window.speechSynthesis.cancel();
                        setIsPaused(true);
                    } else if (isPaused) {
                        isPausedRef.current = false;
                        handleSpeak(true);
                    } else {
                        isPausedRef.current = false;
                        handleSpeak(false);
                    }
                };

                const handleBottomBtnClick = () => {
                    if (cardSide === 3 || cardSide === 5) {
                        togglePlayPause();
                    } else if (cardSide === 4) {
                        showSentences();
                    } else {
                        handleSpeak(false);
                    }
                };

                const highlightTargetWord = (sentence, targetWord) => {
                    if (!targetWord) return sentence;
                    const cleanTarget = targetWord.split('(')[0].trim();
                    const escapedTarget = cleanTarget.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`(${escapedTarget})`, 'gi');
                    const parts = sentence.split(regex);
                    return parts.map((part, index) => 
                        part.toLowerCase() === cleanTarget.toLowerCase() 
                        ? <span key={index} className={`text-accent font-extrabold text-xl sm:text-2xl`}>{part}</span> 
                        : part
                    );
                };

                const theme = isDarkMode ? {
                    headerText: 'text-slate-300 tracking-wide',
                    subText: 'text-slate-400',
                    selectText: 'text-slate-200 font-medium',
                    
                    controlsBg: 'bg-primary-dark border-primary-light/20 control-3d',
                    controlsBorder: '', 
                    
                    cardFrontBg: 'bg-primary-dark card-3d-look border-primary-light/10',
                    cardFrontText: 'text-slate-100',
                    cardBackBg: 'bg-primary-dark card-3d-look border-primary-light/10',
                    
                    buttonBg: 'bg-primary-light/20 hover:bg-primary-light/30 tactile-button text-slate-200',
                    accentBtnBg: 'bg-accent-dark hover:bg-accent tactile-button text-white shadow-lg shadow-accent-dark/30',
                    
                    counterBg: 'bg-primary-dark/30 backdrop-blur-md',
                    counterText: 'text-slate-300'

                } : {
                    headerText: 'text-primary-dark tracking-wide',
                    subText: 'text-slate-500',
                    selectText: 'text-primary-dark font-medium',

                    controlsBg: 'bg-white border-slate-200/50 control-3d',
                    controlsBorder: '',

                    cardFrontBg: 'bg-paper-light card-3d-look border border-slate-100',
                    cardFrontText: 'text-primary-dark',
                    cardBackBg: 'bg-primary text-slate-100 card-3d-look',
                    
                    buttonBg: 'bg-white hover:bg-slate-50 tactile-button text-primary-dark',
                    accentBtnBg: 'bg-accent hover:bg-accent-light tactile-button text-white shadow-lg shadow-accent/30',

                    counterBg: 'bg-white/50 backdrop-blur-md',
                    counterText: 'text-primary-dark'
                };

                if (loading) return <div className="h-[100dvh] flex flex-col items-center justify-center p-4"><div className="text-4xl mb-4 animate-spin text-accent"><Icon path={iconPaths.layers} size={48} /></div><div className="text-lg font-semibold text-primary-light dark:text-slate-300 animate-pulse">Wczytywanie bazy słów...</div></div>;
                if (fileError) return <div className="h-[100dvh] flex flex-col items-center justify-center p-8 text-center"><div className="text-5xl mb-6">⚠️</div><div className="text-2xl font-bold mb-4 text-red-500">Problem z bazą danych</div><pre className="mb-8 text-sm bg-red-50 p-6 rounded-2xl text-left overflow-auto max-w-full whitespace-pre-wrap border border-red-100 shadow-inner">{fileError}</pre><button onClick={() => location.reload()} className="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg tactile-button transition">Odśwież stronę</button></div>;

                const isSide5Active = cardSide === 5 || (prevCardSide === 5 && cardSide !== 1 && cardSide !== 3);
                const isSide4Active = cardSide === 4 || (prevCardSide === 4 && cardSide !== 1);

                const effectiveFrontBg = (!isDarkMode && isSide5Active) ? theme.cardBackBg : theme.cardFrontBg;
                
                const effectiveBackBg = (!isDarkMode && isSide4Active) ? theme.cardFrontBg : theme.cardBackBg;

                return (
                    <div className="h-[100dvh] flex flex-col items-center pt-1 pb-2 px-3 font-sans relative overflow-hidden noselect">
                        {oledMode && (<div className="fixed inset-0 bg-black z-[99999] cursor-pointer animate-fadeIn" onClick={() => handleTripleTap(() => setOledMode(false))}></div>)}
                        
                        {/* --- MENU USTAWIEŃ (RIGHT SLIDE-IN) --- */}
                        {isMenuOpen && (
                            <div className="fixed inset-0 z-[10000] flex justify-end">
                                <div className="absolute inset-0 bg-black/40 backdrop-blur-sm animate-fadeIn" onClick={() => setIsMenuOpen(false)}></div>
                                <div className="relative w-4/5 max-w-sm h-full bg-white dark:bg-primary-dark shadow-2xl animate-slide-in-right flex flex-col overflow-hidden border-l border-white/10">
                                    <div className="p-5 flex justify-between items-center border-b border-gray-100 dark:border-white/5 bg-accent/5">
                                        <h3 className="text-xl font-black text-accent flex items-center gap-2">
                                            <Icon path={iconPaths.settings} size={24}/> Ustawienia
                                        </h3>
                                        <button onClick={() => setIsMenuOpen(false)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 transition-colors">
                                            <Icon path={iconPaths.close} size={24} className="text-slate-500 dark:text-slate-300"/>
                                        </button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-5 space-y-8 custom-scrollbar">
                                        
                                        {/* 1. Wybór Lektora */}
                                        <div className="space-y-3">
                                            <label className="text-xs font-bold uppercase tracking-wider text-slate-400">Lektor (Angielski)</label>
                                            <div className="flex bg-gray-100 dark:bg-black/20 p-1 rounded-xl">
                                                <button onClick={() => setVoiceVariant('US')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${voiceVariant === 'US' ? 'bg-white dark:bg-primary-light shadow-sm text-accent' : 'text-slate-500 hover:text-slate-700'}`}>US 🇺🇸</button>
                                                <button onClick={() => setVoiceVariant('GB')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${voiceVariant === 'GB' ? 'bg-white dark:bg-primary-light shadow-sm text-accent' : 'text-slate-500 hover:text-slate-700'}`}>GB 🇬🇧</button>
                                            </div>
                                        </div>

                                        {/* 2. Prędkość Mowy */}
                                        <div className="space-y-3">
                                            <div className="flex justify-between">
                                                <label className="text-xs font-bold uppercase tracking-wider text-slate-400">Prędkość mowy</label>
                                                <span className="text-xs font-bold text-accent">{speechRate}x</span>
                                            </div>
                                            <input 
                                                type="range" 
                                                min="0.5" 
                                                max="1.5" 
                                                step="0.1" 
                                                value={speechRate} 
                                                onChange={(e) => setSpeechRate(parseFloat(e.target.value))}
                                                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                            />
                                            <div className="flex justify-between text-[10px] text-gray-400 font-medium px-1">
                                                <span>Wolno</span>
                                                <span>Normalnie</span>
                                                <span>Szybko</span>
                                            </div>
                                        </div>

                                        {/* 3. Auto-play */}
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className={`p-2 rounded-lg ${autoPlay ? 'bg-accent/20 text-accent' : 'bg-gray-100 text-gray-400 dark:bg-white/5'}`}>
                                                    <Icon path={iconPaths.autoPlay} size={20} />
                                                </div>
                                                <span className="font-bold text-slate-700 dark:text-slate-200">Auto-czytanie</span>
                                            </div>
                                            <button 
                                                onClick={() => setAutoPlay(!autoPlay)} 
                                                className={`w-12 h-7 rounded-full p-1 transition-colors duration-300 relative ${autoPlay ? 'bg-accent' : 'bg-gray-300 dark:bg-gray-600'}`}
                                            >
                                                <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${autoPlay ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                            </button>
                                        </div>

                                        {/* 4. Tryb Ciemny */}
                                        <div className="flex items-center justify-between">
                                            <span className="font-bold text-slate-700 dark:text-slate-200">Tryb ciemny</span>
                                            <button onClick={() => setIsDarkMode(!isDarkMode)} className={`w-12 h-7 rounded-full p-1 transition-colors duration-300 relative ${isDarkMode ? 'bg-accent' : 'bg-gray-300 dark:bg-gray-600'}`}>
                                                <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 flex items-center justify-center ${isDarkMode ? 'translate-x-5' : 'translate-x-0'}`}>
                                                    <Icon path={isDarkMode ? iconPaths.moon : iconPaths.sun} size={12} className={isDarkMode ? 'text-accent' : 'text-gray-400'}/>
                                                </div>
                                            </button>
                                        </div>

                                        {/* 5. Kierunek Nauki (Nowy Styl w Jednej Linii) */}
                                        <div className="space-y-3">
                                            <label className="text-xs font-bold uppercase tracking-wider text-slate-400">Kierunek nauki</label>
                                            <div className="flex bg-gray-100 dark:bg-black/20 p-1 rounded-xl">
                                                <button 
                                                    onClick={() => setIsPlToEn(false)} 
                                                    className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${!isPlToEn ? 'bg-white dark:bg-primary-light shadow-sm text-accent' : 'text-slate-500 hover:text-slate-700'}`}
                                                >
                                                    EN ➔ PL
                                                </button>
                                                <button 
                                                    onClick={() => setIsPlToEn(true)} 
                                                    className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${isPlToEn ? 'bg-white dark:bg-primary-light shadow-sm text-accent' : 'text-slate-500 hover:text-slate-700'}`}
                                                >
                                                    PL ➔ EN
                                                </button>
                                            </div>
                                        </div>

                                        {/* 6. Czas */}
                                        <div className="space-y-3">
                                            <label className="text-xs font-bold uppercase tracking-wider text-slate-400">Wybrany czas zdań</label>
                                            <select value={tense} onChange={(e) => setTense(e.target.value)} className="w-full p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 font-bold text-slate-700 dark:text-slate-200 outline-none focus:border-accent">
                                                <option value="Base">Podstawowy</option>
                                                {availableTenses.map(t => (<option key={t} value={t}>{t}</option>))}
                                                <option value="mixed">Mix czasów</option>
                                            </select>
                                        </div>

                                        {/* 7. Kolory Motywu */}
                                        <div className="space-y-3">
                                            <label className="text-xs font-bold uppercase tracking-wider text-slate-400">Kolor motywu</label>
                                            <div className="grid grid-cols-2 gap-3">
                                                {Object.keys(themeColors).map(key => (
                                                    <button 
                                                        key={key} 
                                                        onClick={() => setThemeColor(key)}
                                                        className={`p-3 rounded-xl border-2 flex items-center gap-3 transition-all ${themeColor === key ? 'border-current bg-white dark:bg-white/5' : 'border-transparent bg-gray-50 dark:bg-white/5 opacity-70 hover:opacity-100'}`}
                                                        style={{ color: `rgb(${themeColors[key].main})` }}
                                                    >
                                                        <div className="w-6 h-6 rounded-full shadow-sm flex-none" style={{ backgroundColor: `rgb(${themeColors[key].main})` }}></div>
                                                        <span className="font-bold text-sm text-slate-700 dark:text-slate-200">{themeColors[key].name}</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* 8. Reset */}
                                        <div className="pt-4 border-t border-gray-100 dark:border-white/5">
                                            <button onClick={handleFactoryReset} className="w-full py-3 px-4 rounded-xl border border-red-200 dark:border-red-900/30 bg-red-50 dark:bg-red-900/10 text-red-600 dark:text-red-400 font-bold flex items-center justify-center gap-2 hover:bg-red-100 dark:hover:bg-red-900/20 transition-colors">
                                                <Icon path={iconPaths.reset} size={20} /> Przywróć ustawienia fabryczne
                                            </button>
                                        </div>

                                    </div>
                                    <div className="p-5 border-t border-gray-100 dark:border-white/5 bg-gray-50 dark:bg-black/20">
                                        <div className="text-xs text-center text-slate-400">Wersja 2.3 • Fiszki WOJTUKIEWICZ</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isLevelModalOpen && (
                            <div className="fixed inset-0 z-[9999] flex flex-col animate-slideIn glass-panel">
                                <div className={`p-4 flex justify-between items-center flex-none ${theme.controlsBg.replace('control-3d', '')}`}>
                                    <h3 className={`text-lg font-bold flex items-center gap-2 ${theme.headerText}`}><Icon path={iconPaths.barChart} size={22}/> Wybierz poziom</h3>
                                    <button onClick={closeLevelModal} className="p-1.5 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors"><Icon path={iconPaths.close} size={24}/></button>
                                </div>
                                <div className="p-3 text-xs text-center font-medium opacity-70">Kliknij <strong>nazwę</strong>, aby wybrać jeden. Kliknij <strong>kwadracik</strong>, aby zaznaczyć wiele.</div>
                                <div className="flex-1 overflow-y-auto p-3 custom-scrollbar"><div className="flex flex-col gap-2.5">{availableLevels.map(lvl => { const isSelected = tempSelectedLevels.includes(lvl); return (<div key={lvl} className={`flex items-center justify-between p-3 rounded-xl border-2 transition-all duration-200 select-none shadow-sm ${isSelected ? 'item-multi-selected' : `${theme.buttonBg} border-transparent`}`}><div className="flex-1 py-1 font-bold text-xl active:scale-95 transition-transform cursor-pointer" onClick={() => handleSingleSelectLevel(lvl)}>{lvl}</div><div className="pl-4 py-1 cursor-pointer active:scale-90 transition-transform text-gray-400 hover:text-accent" onClick={(e) => handleMultiToggleLevel(e, lvl)}>{isSelected ? <div className="text-accent"><Icon path={iconPaths.checkSquare} size={28} /></div> : <Icon path={iconPaths.square} size={28} />}</div></div>); })}</div></div>
                                {tempSelectedLevels.length > 0 && (<div className="p-3 flex-none z-10 animate-slideUp"><button onClick={confirmMultiLevelSelection} className={`w-full ${theme.accentBtnBg} font-bold py-3 rounded-xl text-base flex items-center justify-center gap-2`}><Icon path={iconPaths.check} size={20} /> Zatwierdź poziomy ({tempSelectedLevels.length})</button></div>)}
                            </div>
                        )}
                        {isCategoryModalOpen && (
                            <div className="fixed inset-0 z-[9999] flex flex-col animate-slideIn glass-panel">
                                <div className={`p-4 flex justify-between items-center flex-none ${theme.controlsBg.replace('control-3d', '')}`}>
                                    <h3 className={`text-lg font-bold flex items-center gap-2 ${theme.headerText}`}><Icon path={iconPaths.filter} size={22}/> Wybierz temat</h3>
                                    <button onClick={closeCategoryModal} className="p-1.5 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors"><Icon path={iconPaths.close} size={24}/></button>
                                </div>
                                <div className="p-3 text-xs text-center font-medium opacity-70">Kliknij <strong>nazwę</strong>, aby wybrać jeden. Kliknij <strong>kwadracik</strong>, aby zaznaczyć wiele.</div>
                                <div className="flex-1 overflow-y-auto p-2 sm:p-3 custom-scrollbar"><div className="flex flex-col gap-2 pb-16">{availableCategories.map(cat => { const isSelected = tempSelectedCategories.includes(cat); return (<div key={cat} className={`flex items-center justify-between p-2.5 px-3 rounded-xl border-2 transition-all duration-200 select-none shadow-sm ${isSelected ? 'item-multi-selected' : `${theme.buttonBg} border-transparent`}`}><div className="flex-1 py-1 font-bold text-base active:scale-95 transition-transform cursor-pointer" onClick={() => handleSingleSelectCategory(cat)}>{cat}</div><div className="pl-3 py-1 cursor-pointer active:scale-90 transition-transform text-gray-400 hover:text-accent" onClick={(e) => handleMultiToggleCategory(e, cat)}>{isSelected ? <div className="text-accent"><Icon path={iconPaths.checkSquare} size={28} /></div> : <Icon path={iconPaths.square} size={28} />}</div></div>); })}</div></div>
                                {tempSelectedCategories.length > 0 && (<div className="p-3 flex-none z-10 animate-slideUp"><button onClick={confirmMultiCategorySelection} className={`w-full ${theme.accentBtnBg} font-bold py-3 rounded-xl text-base flex items-center justify-center gap-2`}><Icon path={iconPaths.check} size={20} /> Zatwierdź wybrane ({tempSelectedCategories.length})</button></div>)}
                            </div>
                        )}

                        <header className="w-full max-w-lg flex-none flex flex-col items-center space-y-3 mt-1 mb-3 p-3 rounded-2xl glass-panel shadow-sm z-10">
                            <div className="w-full relative flex items-center justify-center min-h-[40px]">
                                <div className="absolute left-0">
                                    <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full shadow-sm transition-all duration-300 ${theme.buttonBg} hover:shadow-md`}><div className={isStartAnimating ? "startup-anim" : ""}><Icon path={isDarkMode ? iconPaths.sun : iconPaths.moon} size={20} className={isDarkMode ? "text-yellow-400" : "text-primary"} /></div></button>
                                </div>
                                <h1 onClick={() => handleTripleTap(() => setOledMode(true))} className={`text-lg sm:text-xl font-black flex items-center gap-2 ${theme.headerText} text-center cursor-pointer select-none active:scale-95 transition-transform`}><Icon path={iconPaths.layers} size={24} className="text-accent" /> Fiszki WOJTUKIEWICZ</h1>
                                <div className="absolute right-0">
                                     <button onClick={() => setIsMenuOpen(true)} className={`p-2 rounded-full shadow-sm transition-all duration-300 ${theme.buttonBg} hover:shadow-md`}>
                                        <Icon path={iconPaths.menu} size={20} className={isDarkMode ? "text-slate-200" : "text-primary"} />
                                    </button>
                                </div>
                            </div>
                            <div className="w-full grid grid-cols-2 gap-2 sm:gap-3">
                                <div onClick={openLevelModal} className={`${theme.controlsBg} px-3 py-2 rounded-xl flex flex-col justify-center cursor-pointer active:scale-95 hover:brightness-95`}><label className={`text-[10px] sm:text-xs font-bold uppercase block mb-0.5 ${theme.subText} tracking-wider`}>Poziom</label><div className={`w-full bg-transparent font-bold text-xs sm:text-sm whitespace-nowrap overflow-hidden text-ellipsis ${theme.selectText}`}>{getLevelLabel()}</div></div>
                                <div onClick={openCategoryModal} className={`${theme.controlsBg} px-3 py-2 rounded-xl flex flex-col justify-center cursor-pointer active:scale-95 hover:brightness-95`}><label className={`text-[10px] sm:text-xs font-bold uppercase mb-0.5 flex items-center gap-1 ${theme.subText} tracking-wider`}><Icon path={iconPaths.tag} size={10} className="sm:w-3 sm:h-3 opacity-70"/> Temat</label><div className={`w-full bg-transparent font-bold text-xs sm:text-sm whitespace-nowrap overflow-hidden text-ellipsis ${theme.selectText}`}>{getCategoryLabel()}</div></div>
                            </div>
                            <div className={`${theme.counterBg} px-3 py-1.5 rounded-full text-xs sm:text-sm font-bold whitespace-nowrap ${theme.counterText} shadow-sm w-auto text-center mt-0.5 flex items-center gap-2`}>
                                <Icon path={iconPaths.barChart} size={14} className="opacity-60"/>
                                {viewAllSentences && sentencesListToRender.length > 0 ? (() => { const currentS = sentencesListToRender[speakingSentenceIndex]; const currentWordNum = currentS ? currentS.wordIndex + 1 : 1; return `Słowo: ${currentWordNum} / ${currentWordIds.length}`; })() : (currentWordIds.length > 0 ? `${isFinished ? currentWordIds.length : currentIndex + 1} / ${currentWordIds.length}` : '0 / 0')}
                            </div>
                        </header>

                        {isFinished ? (
                                <div className="w-full max-w-md flex-1 min-h-[300px] mb-3 z-10 flex flex-col items-center justify-center animate-popIn perspective-1000">
                                <div className={`w-full p-6 rounded-[24px] flex flex-col items-center justify-center text-center ${theme.cardFrontBg} transition-all duration-500`}>
                                    <div className={`mb-6 p-6 rounded-full bg-yellow-100 dark:bg-yellow-900/30 shadow-inner animate-bounce-slow`}><Icon path={iconPaths.trophy} size={64} className="text-yellow-500 drop-shadow-sm" /></div>
                                    <h2 className={`text-3xl font-black mb-2 ${theme.cardFrontText} tracking-tight`}>Gratulacje!</h2>
                                    <p className={`text-lg mb-8 ${theme.subText} font-medium`}>Brawo, skończyłeś całą kategorię!</p>
                                    <button onClick={handleReset} className={`${theme.accentBtnBg} py-3 px-8 rounded-xl text-lg flex items-center gap-2`}>
                                        <div className="animate-spin-three"><Icon path={iconPaths.rotate} size={20} /></div> Zacznij od nowa
                                    </button>
                                </div>
                                </div>
                        ) : (
                            <>
                                <div className="relative w-full max-w-md flex-1 min-h-[300px] mb-3 z-0 perspective-1000">
                                    
                                    {isShuffling ? (
                                        <div className={`w-full h-full rounded-[24px] flex flex-col items-center justify-center p-6 text-center animate-card-shake ${theme.cardFrontBg}`}>
                                            <div className="mb-4 animate-spin text-accent">
                                                <Icon path={iconPaths.rotate} size={48} />
                                            </div>
                                            <h2 className={`text-xl font-bold animate-pulse ${theme.cardFrontText}`}>
                                                Losowanie kolejki słów...
                                            </h2>
                                        </div>
                                    ) : (
                                        <div className={`relative w-full h-full rounded-[24px] cursor-pointer transform-style-3d ${noTransition ? '' : 'transition-transform duration-500 ease-out-back'}`} style={{ transform: `rotateY(${rotation}deg) rotateX(${rotationX}deg)` }} onClick={handleCardClick} onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd} onMouseDown={onMouseDown} onMouseMove={onMouseMove} onMouseUp={onMouseUp} onMouseLeave={onMouseLeave}>
                                            
                                            <div className={`absolute inset-0 w-full h-full rounded-[24px] flex flex-col items-center justify-center p-4 sm:p-5 backface-hidden ${effectiveFrontBg} transition-colors duration-500`} style={{ transform: 'rotateY(0deg)' }}>
                                                {(cardSide === 3 || (prevCardSide === 3 && (cardSide === 2 || cardSide === 4))) ? (
                                                    <div className="w-full h-full flex flex-col animate-fadeIn relative">
                                                        <div className="flex justify-between items-center mb-3 border-b border-gray-200/10 pb-2 flex-none relative">
                                                            <h3 className={`font-bold flex items-center gap-2 text-base ${theme.headerText}`}><Icon path={iconPaths.book} size={18} className="text-accent"/> Zdania</h3>
                                                            
                                                            <div className="flex items-center gap-2" onClick={(e) => e.stopPropagation()}>
                                                                <button onClick={showGrammarInfo} className={`flex items-center gap-1 px-2 py-1 rounded-lg tactile-button ${theme.buttonBg}`}>
                                                                    <Icon path={iconPaths.infoCircle} size={16} className="text-accent"/> <span className="text-[10px] font-bold uppercase">Gramatyka</span>
                                                                </button>

                                                                <div className={`flex items-center gap-1 px-2 py-1 rounded-lg tactile-button ${theme.buttonBg}`}>
                                                                    <Icon path={iconPaths.clock} size={16} className="text-accent"/>
                                                                    <select value={tense} onChange={(e) => setTense(e.target.value)} onClick={(e) => e.stopPropagation()} className={`bg-transparent text-[10px] !font-bold uppercase outline-none w-[90px] ${theme.selectText} appearance-none cursor-pointer`}><option value="Base" className="text-gray-900 bg-white">Wybierz czas</option>{availableTenses.map(t => (<option key={t} value={t} className="text-gray-900 bg-white">{t}</option>))}<option value="mixed" className="text-gray-900 bg-white">Mix czasów</option></select>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <ul className="space-y-3 text-base text-left overflow-y-auto pr-1 custom-scrollbar flex-1 pb-3 relative -mr-1 pl-1">{sentencesListToRender.length > 0 ? sentencesListToRender.map((s, i) => (<li key={i} ref={el => itemRefs.current[i] = el} className={`flex flex-col gap-1 transition-transform duration-300 origin-left rounded-lg p-2 ${activeSentenceIndex === i ? 'scale-105 z-10 bg-accent/10 shadow-sm -ml-1' : 'scale-100 z-0'}`}><div className="flex gap-2 leading-snug font-medium"><span className={`${isDarkMode ? 'text-slate-200' : 'text-primary-dark'} transition-colors-all duration-500`}>{highlightTargetWord(s.en, viewAllSentences ? s.word : (displayData ? displayData.word : ''))}</span></div>{s.pl && tense !== 'Beginner' && (<div className={`pl-3 text-sm italic ${theme.subText} border-l-2 border-accent/30`}>{s.pl}</div>)}</li>)) : <li className="text-center opacity-50 italic mt-8 flex flex-col items-center gap-3"><Icon path={iconPaths.filter} size={32} className="opacity-30" />Brak zdań dla tego czasu</li>}</ul>
                                                        
                                                        <div className="relative w-full mt-3 flex justify-between items-center flex-none p-2 rounded-xl bg-black/5 dark:bg-white/5">
                                                                
                                                                <button onClick={(e) => { e.stopPropagation(); setViewAllSentences(!viewAllSentences); }} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold ${viewAllSentences ? 'bg-accent/15 text-accent border border-accent/20 shadow-none' : theme.buttonBg}`} title={viewAllSentences ? "Pokaż tylko dla tego słowa" : "Wczytaj wszystkie zdania z tej kategorii"}>
                                                                    <div className={viewAllSentences ? "" : "animate-spin-three"}><Icon path={iconPaths.reloadCustom} size={16} /></div><span className="text-[10px] font-bold uppercase whitespace-nowrap">All</span>
                                                                </button>
                                                            
                                                            <div className={`font-mono text-lg font-bold opacity-70 ${theme.subText} tracking-wider`}>{currentPhoneticToDisplay}</div>
                                                            
                                                                <button onClick={togglePauseDuration} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold ${theme.buttonBg}`}>
                                                                    <Icon path={iconPaths.runningMan} size={16} className={pauseDuration !== 0 ? "text-accent" : "opacity-50"} />
                                                                    <span className={pauseDuration !== 0 ? "text-accent" : "opacity-50"}>{pauseDuration > 0 ? `+${pauseDuration}` : pauseDuration}</span>
                                                                </button>
                                                        </div>
                                                    </div>
                                                ) : (cardSide === 5 || (prevCardSide === 5 && cardSide !== 1 && cardSide !== 3)) ? (
                                                    <div className="w-full h-full flex flex-col animate-fadeIn relative rotate-180">
                                                        <div className="flex-none mb-3 border-b border-gray-200/10 pb-2">
                                                            <h3 className={`text-lg font-bold flex items-center gap-2 text-accent-light`}><Icon path={iconPaths.infoCircle} size={20} className="text-accent"/> Word Info</h3>
                                                        </div>
                                                        <div className="flex-1 overflow-y-auto custom-scrollbar text-left text-base leading-relaxed pr-2 -mr-2 relative">
                                                            <div className="p-1">
                                                            {displayData && displayData.wordInfo ? (
                                                                <div className={`whitespace-pre-line font-medium ${(!isDarkMode && isSide5Active) ? 'text-slate-200' : 'text-primary-dark'} dark:text-slate-200`}>{displayData.wordInfo}</div>
                                                            ) : (
                                                                <div className="italic opacity-60 text-center mt-16 flex flex-col items-center gap-3"><Icon path={iconPaths.fileText} size={40} className="opacity-30" />Brak dodatkowych informacji.</div>
                                                            )}
                                                            </div>
                                                        </div>
                                                        <div className="flex-none mt-4 w-full">
                                                            <button onClick={showTranslation} className={`w-full bg-primary-light/20 hover:bg-primary-light/30 tactile-button text-slate-200 font-bold py-3 rounded-xl text-base flex items-center justify-center gap-2`}>
                                                                <Icon path={iconPaths.rotate} size={20}/> Wróć do tłumaczenia
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div className={`absolute top-4 left-4 text-xs font-bold uppercase flex flex-wrap items-center gap-2 ${theme.subText} tracking-wider`}><span className="px-2 py-0.5 rounded-full bg-black/5 dark:bg-white/10 backdrop-blur-md truncate max-w-[100px] sm:max-w-none">{tense === 'mixed' ? 'Mix' : (tense === 'Base' ? 'Słowo En.' : tense)}</span></div>
                                                        <button onClick={(e) => { e.stopPropagation(); setIsPlToEn(!isPlToEn); }} className={`absolute top-4 right-4 px-3 py-1.5 rounded-full text-xs font-bold border ${theme.controlsBorder} ${theme.buttonBg} flex items-center gap-1 shadow-sm group`}>
                                                        <Icon path={iconPaths.swap} size={14} className="text-accent group-hover:rotate-180 transition-transform duration-300"/> {isPlToEn ? "PL ➔ EN" : "EN ➔ PL"}
                                                        </button>
                                                        <div className="flex-1 flex items-center justify-center w-full px-2">
                                                            <h2 className={`${getWordSizeClass(isPlToEn ? (displayData ? displayData.translation : '') : (displayData ? displayData.word : ''))} font-black text-center break-words leading-tight ${theme.cardFrontText} drop-shadow-sm tracking-tight`}>
                                                                {displayData ? (isPlToEn ? displayData.translation : displayData.word) : '...'}
                                                            </h2>
                                                        </div>
                                                        <div className={`absolute bottom-4 text-xs flex items-center gap-1 font-bold uppercase ${theme.subText} opacity-60 tracking-widest animate-pulse`}><Icon path={iconPaths.rotate} size={12}/> Kliknij, aby obrócić</div>
                                                    </>
                                                )}
                                            </div>

                                            <div className={`absolute inset-0 w-full h-full rounded-[24px] flex flex-col items-center justify-center p-4 sm:p-5 backface-hidden ${effectiveBackBg} transition-colors duration-500`} style={{ transform: (cardSide === 4 || (prevCardSide === 4 && cardSide !== 1)) ? 'rotateX(180deg)' : 'rotateY(180deg)' }}>
                                                {(cardSide === 4 || (prevCardSide === 4 && cardSide !== 1)) ? (
                                                    <div className="w-full h-full flex flex-col animate-fadeIn relative">
                                                        <div className="flex-none mb-3 border-b border-white/10 pb-2">
                                                            <h3 className={`text-lg font-bold flex items-center gap-2 ${(!isDarkMode && isSide4Active) ? 'text-accent' : 'text-accent-light'}`}><Icon path={iconPaths.infoCircle} size={20}/> Gramatyka</h3>
                                                        </div>
                                                        <div className="flex-1 overflow-y-auto custom-scrollbar text-left text-base leading-relaxed pr-2 -mr-2 relative">
                                                            <div className="p-1">
                                                            {displayData && displayData.infoText ? (
                                                                <div className={`whitespace-pre-line font-medium ${(!isDarkMode && isSide4Active) ? 'text-primary-dark' : ''}`}>{displayData.infoText}</div>
                                                            ) : (
                                                                <div className="italic opacity-60 text-center mt-16 flex flex-col items-center gap-3"><Icon path={iconPaths.fileText} size={40} className="opacity-30" />Brak informacji gramatycznych dla tego czasu.</div>
                                                            )}
                                                            </div>
                                                        </div>
                                                        <div className="flex-none mt-4 w-full">
                                                            <button onClick={showSentences} className={`w-full ${(!isDarkMode && isSide4Active) ? theme.buttonBg : 'bg-white/10 hover:bg-white/20 tactile-button text-white'} font-bold py-3 rounded-xl text-base flex items-center justify-center gap-2`}>
                                                                <Icon path={iconPaths.book} size={20}/> Wróć do zdań
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div className="absolute top-4 right-4 text-xs font-bold text-accent-light uppercase tracking-wider px-2 py-0.5 rounded-full bg-white/10 backdrop-blur-md shadow-inner">
                                                            {isPlToEn ? "Po angielsku" : "Tłumaczenie"}
                                                        </div>

                                                        <div className="absolute bottom-4 left-4">
                                                            <button onClick={showBeginnerInfo} className="flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-bold bg-white/10 hover:bg-white/20 tactile-button text-accent-light shadow-sm transition-all group">
                                                                <Icon path={iconPaths.infoCircle} size={16} className="group-hover:scale-110 transition-transform"/> <span className="hidden sm:inline">Word Info</span>
                                                            </button>
                                                        </div>

                                                        <h2 className={`${getTranslationSizeClass(isPlToEn ? (displayData ? displayData.word : '') : (displayData ? displayData.translation : ''))} font-black mb-4 text-center leading-tight break-words max-w-full tracking-tight drop-shadow-md`}>
                                                            {displayData ? (isPlToEn ? displayData.word : displayData.translation) : ''}
                                                        </h2>

                                                        <div className="relative w-full flex justify-center items-center flex-none mb-6">
                                                            <div className={`bg-black/20 px-6 py-2 rounded-xl font-mono font-bold shadow-inner text-accent-light ${getPhoneticSizeClass(displayData ? displayData.phonetic : '')}`}>{displayData ? displayData.phonetic : '---'}</div>
                                                        </div>

                                                        <button onClick={showSentences} className={`font-bold py-2 px-6 rounded-xl shadow-lg ${theme.buttonBg} flex items-center gap-2 text-base transition-all hover:scale-105`}>
                                                            <Icon path={iconPaths.book} size={20} className="text-accent"/> {tense === 'Base' ? 'Zdania' : `Zdania (${tense})`}
                                                        </button>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="w-full max-w-md flex-none space-y-3 z-20 mb-1 glass-panel p-3 rounded-[24px] shadow-soft-xl">
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={handlePrev} className={`${theme.buttonBg} font-bold py-3 rounded-xl flex justify-center items-center gap-2 text-sm group`}><Icon path={iconPaths.left} className="w-5 h-5 text-accent group-hover:-translate-x-1 transition-transform" /> Poprzednia</button>
                                        <button onClick={handleNext} className={`${theme.buttonBg} font-bold py-3 rounded-xl flex justify-center items-center gap-2 text-sm group`}>Następna <Icon path={iconPaths.right} className="w-5 h-5 text-accent group-hover:translate-x-1 transition-transform" /></button>
                                    </div>
                                    <button onClick={handleBottomBtnClick} className={`w-full text-lg font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-3 transition-all duration-300 hover:scale-[1.02] active:scale-100 ${isSpeaking && !isPaused ? "bg-emerald-600 hover:bg-emerald-700 text-white tactile-button shadow-emerald-500/30" : theme.accentBtnBg}`}>
                                        {cardSide === 3 || cardSide === 5
                                            ? (
                                                <>
                                                    {isSpeaking && !isPaused ? <Icon path={iconPaths.pause} size={24} className="animate-pulse"/> : <Icon path={iconPaths.play} size={24} className="ml-1"/>}
                                                    {isSpeaking && !isPaused ? "Pauza" : (isPaused ? "Wznów" : "Czytaj zdania")}
                                                </>
                                            ) 
                                            : (cardSide === 4 ? (
                                                <>
                                                    <Icon path={iconPaths.book} size={24}/> Wróć do zdań
                                                </>
                                            ) : (
                                                <>
                                                    {isSpeaking ? <Icon path={iconPaths.volX} size={24} className="animate-pulse"/> : <Icon path={iconPaths.vol} size={24}/>}
                                                    {isSpeaking ? "Odtwarzanie..." : "Czytaj wymowę"}
                                                </>
                                            ))
                                        }
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                );
            }
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<FlashcardsApp />);
        } catch (err) { document.getElementById('error-overlay').style.display = 'flex'; document.getElementById('error-message').textContent = err.toString(); }
    </script>
</body>
</html>