<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fiszki WOJTUKIEWICZ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-in-out; }
        
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-popIn { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* Animacja: 3 obroty (1080 stopni) w 3 sekundy */
        @keyframes spinThreeTimes { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(1080deg); } 
        }
        .animate-spin-three { animation: spinThreeTimes 3s ease-in-out; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        
        #error-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.98); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: #991b1b; padding: 20px; text-align: center; }
        .no-tap-highlight { -webkit-tap-highlight-color: transparent; }
        .transition-colors-all { transition-property: background-color, border-color, color, fill, stroke; transition-duration: 300ms; }
        .noselect {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="m-0 transition-colors duration-300 no-tap-highlight overflow-hidden">

    <div id="error-overlay">
        <h2 class="text-2xl font-bold mb-2">Wystąpił błąd</h2>
        <p class="mb-4 text-gray-600">Nie udało się załadować bazy danych Excel.</p>
        <div id="local-file-warning" class="hidden mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm max-w-md text-left">
            <strong>⚠️ Wykryto uruchomienie lokalne (file://)</strong><br/><br/>
            Przeglądarki mogą blokować wczytywanie pliku <code>bazaA1.xlsx</code> z dysku ze względów bezpieczeństwa (CORS).<br/>
            Aby to działało lokalnie, najlepiej uruchomić prosty serwer (np. Live Server w VS Code).
        </div>
        <pre id="error-message" class="bg-red-100 p-4 rounded text-sm text-left overflow-auto max-w-full max-h-64 select-text"></pre>
        <button onclick="location.reload()" class="bg-red-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 transition mt-4">Spróbuj ponownie</button>
    </div>

    <div id="root"></div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-overlay').style.display = 'flex';
            document.getElementById('error-message').textContent = `JS Error: ${msg}\nLine: ${line}`;
            if (window.location.protocol === 'file:') {
                document.getElementById('local-file-warning').style.display = 'block';
            }
            return false;
        };
    </script>

    <script type="text/babel">
        try {
            const { useState, useEffect, useMemo } = React;

            const Icon = ({ path, size = 24, className="" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
            );

            const iconPaths = {
                layers: <><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>,
                book: <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>,
                rotate: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>,
                left: <><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>,
                right: <><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>,
                vol: <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></>,
                volX: <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></>,
                tag: <><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></>,
                clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                moon: <><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></>,
                sun: <><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>,
                close: <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>,
                trophy: <><path d="M8 21h8"/><path d="M12 17v4"/><path d="M7 4h10"/><path d="M17 4v8a5 5 0 0 1-10 0V4"/><path d="M5 9v1a2 2 0 0 0 2 2"/><path d="M19 9v1a2 2 0 0 1-2 2"/></>,
                reloadCustom: <><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></>
            };

            const parseSentenceRow = (text) => {
                if (!text) return null;
                const lastParenIndex = text.lastIndexOf('(');
                if (lastParenIndex === -1) return { en: text.trim(), pl: '' };
                
                const en = text.substring(0, lastParenIndex).trim();
                const pl = text.substring(lastParenIndex + 1, text.length - 1).trim(); 
                return { en, pl };
            };

            const extractSentencesFromCell = (cellContent) => {
                if (!cellContent) return [];
                let strContent = String(cellContent).trim();
                if (!strContent) return [];
                
                strContent = strContent.replace(/(?:^|\s+)([1-5]\.)\s*/g, '\n$1 ');
                strContent = strContent.replace(/\)/g, ')\n');

                const lines = strContent.split(/\r?\n/).filter(line => line.trim() !== "");
                return lines.map(line => parseSentenceRow(line)).filter(s => s && s.en);
            };

            const getWordSizeClass = (text) => {
                if (!text) return "text-5xl sm:text-7xl";
                const len = text.length;
                if (len < 12) return "text-5xl sm:text-7xl"; 
                if (len < 20) return "text-4xl sm:text-6xl"; 
                if (len < 30) return "text-3xl sm:text-5xl"; 
                return "text-xl sm:text-3xl"; 
            };

            const getTranslationSizeClass = (text) => {
                if (!text) return "text-5xl sm:text-6xl";
                const len = text.length;
                if (len < 15) return "text-5xl sm:text-6xl"; 
                if (len < 30) return "text-3xl sm:text-5xl"; 
                if (len < 50) return "text-2xl sm:text-3xl"; 
                return "text-lg sm:text-xl"; 
            };
            
            const getPhoneticSizeClass = (text) => {
                if (!text) return "text-3xl sm:text-4xl";
                const len = text.length;
                if (len < 20) return "text-3xl sm:text-4xl";
                return "text-xl sm:text-2xl";
            };

            function FlashcardsApp() {
                const [fullDatabase, setFullDatabase] = useState([]);
                const [loading, setLoading] = useState(true);
                const [fileError, setFileError] = useState(null);

                const [level, setLevel] = useState('A1');
                const [category, setCategory] = useState('all');
                const [tense, setTense] = useState('Base');
                
                const [availableCategories, setAvailableCategories] = useState([]);
                const [currentWordIds, setCurrentWordIds] = useState([]);
                const [currentIndex, setCurrentIndex] = useState(0);
                const [isFinished, setIsFinished] = useState(false);
                
                const [cardSide, setCardSide] = useState(1);
                const [rotation, setRotation] = useState(0);
                const [noTransition, setNoTransition] = useState(false);
                const [isSpeaking, setIsSpeaking] = useState(false);
                const [isDarkMode, setIsDarkMode] = useState(false);

                const [viewAllSentences, setViewAllSentences] = useState(false);
                
                const [voices, setVoices] = useState([]);
                const [selectedVoice, setSelectedVoice] = useState(null);

                const [touchStart, setTouchStart] = useState(null);
                const [touchEnd, setTouchEnd] = useState(null);
                const minSwipeDistance = 50;

                useEffect(() => {
                    const loadVoices = () => {
                        const availableVoices = window.speechSynthesis.getVoices();
                        setVoices(availableVoices);
                    };

                    loadVoices();
                    
                    if (window.speechSynthesis.onvoiceschanged !== undefined) {
                        window.speechSynthesis.onvoiceschanged = loadVoices;
                    }
                }, []);

                useEffect(() => {
                    if (voices.length > 0) {
                        const bestVoice = 
                            voices.find(v => v.name.includes("Google US English")) ||
                            voices.find(v => v.name.includes("Google UK English Female")) ||
                            voices.find(v => v.name.includes("Samantha")) || 
                            voices.find(v => v.name.includes("Zira")) ||
                            voices.find(v => v.lang === 'en-US' && v.name.includes("Natural")) ||
                            voices.find(v => v.lang === 'en-US') ||
                            voices.find(v => v.lang.startsWith('en'));

                        if (bestVoice) {
                            setSelectedVoice(bestVoice);
                        }
                    }
                }, [voices]);

                useEffect(() => {
                    setLoading(true);
                    const excelUrl = `bazaA1.xlsx?t=${new Date().getTime()}`;
                    
                    fetch(excelUrl)
                        .then(res => {
                            if (!res.ok) throw new Error(`Błąd sieci: ${res.status} ${res.statusText}`);
                            return res.arrayBuffer();
                        })
                        .then(ab => {
                            const workbook = XLSX.read(ab, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);

                            if (jsonData && jsonData.length > 0) {
                                const tenseColumns = [
                                    "Present Simple", "Present continuous", "Past Simple", 
                                    "Future Simple", "Present Perfect", "Past Continuous", "Going To"
                                ];

                                const processedData = [];

                                jsonData.forEach(row => {
                                    const id = row.id;
                                    const rawLevel = row.level ? String(row.level).trim() : "A1";
                                    const rawCat = row.category ? String(row.category).trim() : "Inne";
                                    const word = row.word ? String(row.word).trim() : "";
                                    const translation = row.translation ? String(row.translation).trim() : "";
                                    const phonetic = row.phonetic ? String(row.phonetic).trim() : "";
                                    
                                    const baseSentences = extractSentencesFromCell(row.base);

                                    processedData.push({
                                        id: id,
                                        level: rawLevel,
                                        category: rawCat,
                                        word: word,
                                        translation: translation,
                                        phonetic: phonetic,
                                        tense: 'Base',
                                        sentencesList: baseSentences
                                    });

                                    tenseColumns.forEach(tenseName => {
                                        if (row[tenseName]) {
                                            const tenseSentences = extractSentencesFromCell(row[tenseName]);
                                            if (tenseSentences.length > 0) {
                                                processedData.push({
                                                    id: id,
                                                    level: rawLevel,
                                                    category: rawCat,
                                                    word: word,
                                                    translation: translation,
                                                    phonetic: phonetic,
                                                    tense: tenseName,
                                                    sentencesList: tenseSentences
                                                });
                                            }
                                        }
                                    });
                                });

                                setFullDatabase(processedData);
                                setLoading(false);
                            } else {
                                setFileError("Plik Excel wygląda na pusty.");
                                setLoading(false);
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            setFileError(`Błąd wczytywania Excela: ${err.message}. Upewnij się, że plik 'bazaA1.xlsx' jest w tym samym folderze.`);
                            setLoading(false);
                        });
                }, []);

                useEffect(() => {
                    if (!fullDatabase.length) {
                        setAvailableCategories([]);
                        return;
                    }
                    const levelData = fullDatabase.filter(row => row.level === level);
                    const cats = [...new Set(levelData.map(row => row.category))].sort((a, b) => 
                        a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
                    );
                    setAvailableCategories(cats);
                    setCategory('all');
                }, [level, fullDatabase]);

                useEffect(() => {
                    if (!fullDatabase.length) return;
                    const uniqueIds = [...new Set(
                        fullDatabase
                            .filter(row => {
                                const levelMatch = row.level === level;
                                const catMatch = category === 'all' ? true : row.category === category;
                                return levelMatch && catMatch;
                            })
                            .map(row => row.id)
                    )];
                    
                    const shuffledIds = [...uniqueIds].sort(() => Math.random() - 0.5);
                    setCurrentWordIds(shuffledIds);
                    setCurrentIndex(0);
                    setIsFinished(false);
                    resetCard();
                }, [category, level, fullDatabase]);

                const availableTenses = useMemo(() => {
                      if (!currentWordIds.length || !fullDatabase.length) return [];
                      const currentId = currentWordIds[currentIndex];
                      const rows = fullDatabase.filter(row => row.id === currentId);
                      const tenses = rows.map(r => r.tense).filter(t => t && t !== 'Base');
                      return [...new Set(tenses)];
                }, [currentWordIds, currentIndex, fullDatabase]);

                const allCategorySentences = useMemo(() => {
                    if (!viewAllSentences) return [];
                    if (!fullDatabase.length) return [];

                    const filteredRows = fullDatabase.filter(row => {
                        const lvlMatch = row.level === level;
                        const catMatch = category === 'all' ? true : row.category === category;
                        return lvlMatch && catMatch;
                    });

                    let finalRows = [];
                    if (tense === 'mixed') {
                        finalRows = filteredRows.filter(r => r.tense !== 'Base');
                    } else {
                        finalRows = filteredRows.filter(r => r.tense === tense);
                    }

                    let sentences = [];
                    finalRows.forEach(row => {
                        if (row.sentencesList && row.sentencesList.length > 0) {
                            row.sentencesList.forEach(s => {
                                sentences.push({ ...s, word: row.word }); 
                            });
                        }
                    });

                    return sentences;
                }, [viewAllSentences, fullDatabase, level, category, tense]);

                const getDisplayData = () => {
                    if (!fullDatabase.length) return null;
                    
                    if (!currentWordIds.length) {
                        return {
                            isEmpty: true,
                            word: "Brak słówek",
                            translation: "Spróbuj zmienić kategorię lub poziom",
                            phonetic: "---",
                            sentences: []
                        };
                    }

                    const currentId = currentWordIds[currentIndex];
                    const baseRow = fullDatabase.find(row => row.id === currentId && row.tense === 'Base');
                    const fallbackRow = fullDatabase.find(row => row.id === currentId);
                    const mainInfoRow = baseRow || fallbackRow;
                    
                    if (!mainInfoRow) return null;

                    let sentences = [];

                    if (tense === 'mixed') {
                        const allVariations = fullDatabase.filter(row => row.id === currentId && row.tense !== 'Base');
                        allVariations.forEach(row => {
                            if (row.sentencesList) {
                                sentences.push(...row.sentencesList);
                            }
                        });
                        sentences = sentences.sort(() => Math.random() - 0.5).slice(0, 5);
                    } else if (tense === 'Base') {
                        if (baseRow && baseRow.sentencesList) {
                            sentences = baseRow.sentencesList;
                        }
                    } else {
                        const activeRow = fullDatabase.find(row => row.id === currentId && row.tense === tense);
                        if (activeRow && activeRow.sentencesList) {
                            sentences = activeRow.sentencesList;
                        }
                    }

                    return { 
                        word: mainInfoRow.word,          
                        translation: mainInfoRow.translation, 
                        phonetic: mainInfoRow.phonetic, 
                        sentences: sentences
                    };
                };

                const displayData = getDisplayData();
                
                const sentencesListToRender = viewAllSentences ? allCategorySentences : (displayData ? displayData.sentences : []);

                const handleStart = (clientX) => { setTouchEnd(null); setTouchStart(clientX); };
                const handleMove = (clientX) => { setTouchEnd(clientX); };
                const handleEnd = () => {
                    if (!touchStart || !touchEnd) return;
                    const distance = touchStart - touchEnd;
                    if (distance > minSwipeDistance) handleNext();
                    else if (distance < -minSwipeDistance) handlePrev();
                    setTouchStart(null); setTouchEnd(null);
                };

                const onTouchStart = (e) => handleStart(e.targetTouches[0].clientX);
                const onTouchMove = (e) => handleMove(e.targetTouches[0].clientX);
                const onTouchEnd = () => handleEnd();
                const onMouseDown = (e) => handleStart(e.clientX);
                const onMouseMove = (e) => { if(touchStart) handleMove(e.clientX); };
                const onMouseUp = () => {
                    if (touchStart && touchEnd && Math.abs(touchStart - touchEnd) > minSwipeDistance) handleEnd();
                    setTouchStart(null); setTouchEnd(null);
                };
                const onMouseLeave = () => { setTouchStart(null); setTouchEnd(null); };

                const resetCard = () => {
                    setNoTransition(true); setCardSide(1); setRotation(0); cancelSpeech(); setViewAllSentences(false);
                    setTimeout(() => setNoTransition(false), 50); 
                };

                const handleNext = () => {
                    if (!currentWordIds.length) return;
                    if (isFinished) return;
                    
                    setViewAllSentences(false);

                    if (currentIndex >= currentWordIds.length - 1) {
                        setIsFinished(true);
                        setNoTransition(true); setCardSide(1); setRotation(0);
                        return;
                    }

                    setNoTransition(true); setCardSide(1); setRotation(0);
                    setTimeout(() => {
                        setNoTransition(false);
                        setCurrentIndex((prev) => prev + 1);
                    }, 50);
                };

                const handlePrev = () => {
                    if (!currentWordIds.length) return;
                    if (isFinished) return; 

                    setViewAllSentences(false);

                    setNoTransition(true); setCardSide(1); setRotation(0);
                    setTimeout(() => {
                        setNoTransition(false);
                        setCurrentIndex((prev) => (prev - 1 + currentWordIds.length) % currentWordIds.length);
                    }, 50);
                };

                const handleReset = () => {
                    setIsFinished(false);
                    setCurrentIndex(0);
                    resetCard();
                };

                const handleCardClick = () => {
                    if (isFinished) return;
                    if (displayData.isEmpty) return;
                    if (cardSide === 1) { setCardSide(2); setRotation(180); }
                    else if (cardSide === 2) { setCardSide(1); setRotation(0); }
                    else if (cardSide === 3) { showTranslation(); }
                };

                const showSentences = (e) => { if(e) e.stopPropagation(); setCardSide(3); setRotation(360); };
                const showTranslation = (e) => { 
                    if(e) e.stopPropagation(); 
                    setCardSide(2); 
                    setRotation(180); 
                    setViewAllSentences(false); 
                };

                const handleSpeak = () => {
                    if (isFinished) return;
                    if (!displayData || !window.speechSynthesis || displayData.isEmpty) return;
                    window.speechSynthesis.cancel();
                    
                    let textToSpeak = "";
                    
                    // Funkcja czyszcząca numerki (np. "1. ", "2.") z początku zdania
                    const cleanSentence = (txt) => txt.replace(/^\s*[0-9]+\.\s*/g, '').trim();

                    if (cardSide === 3) {
                        if (viewAllSentences) {
                            // Tryb czytania WSZYSTKICH zdań z kategorii
                            const parts = [];
                            let lastWord = "";

                            sentencesListToRender.forEach((s, index) => {
                                // Jeśli zmieniło się słowo (lub to pierwsze słowo)
                                if (s.word !== lastWord) {
                                    if (lastWord !== "") {
                                        // Dodaj wyraźną pauzę przed nowym słowem
                                        parts.push(". . ."); 
                                    }
                                    lastWord = s.word;
                                    // Przeczytaj słowo przewodnie
                                    parts.push(lastWord);
                                }
                                // Dodaj oczyszczone zdanie (bez numerków)
                                parts.push(cleanSentence(s.en));
                            });
                            textToSpeak = parts.join('. ');
                        } else {
                            // Tryb czytania zdań tylko dla JEDNEGO słowa
                            textToSpeak = displayData.sentences.map(s => cleanSentence(s.en)).join('. ');
                        }
                    } else {
                         if (tense !== 'Base' && tense !== 'mixed' && displayData.sentences.length > 0) {
                             textToSpeak = cleanSentence(displayData.sentences[0].en); 
                         } else {
                             textToSpeak = displayData.word;
                         }
                    }

                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }
                    
                    utterance.lang = 'en-US';
                    utterance.rate = 0.7; 
                    utterance.pitch = 1;

                    utterance.onstart = () => setIsSpeaking(true);
                    utterance.onend = () => setIsSpeaking(false);
                    utterance.onerror = (e) => {
                        console.error("Speech error", e);
                        setIsSpeaking(false);
                    };

                    window.speechSynthesis.speak(utterance);
                };

                const cancelSpeech = () => { if (window.speechSynthesis) window.speechSynthesis.cancel(); setIsSpeaking(false); };

                const highlightTargetWord = (sentence, targetWord) => {
                    if (!targetWord) return sentence;
                    const cleanTarget = targetWord.split('(')[0].trim();
                    const escapedTarget = cleanTarget.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`(${escapedTarget})`, 'gi');
                    const parts = sentence.split(regex);
                    
                    return parts.map((part, index) => 
                        part.toLowerCase() === cleanTarget.toLowerCase() 
                        ? <span key={index} className={`${isDarkMode ? 'text-red-400' : 'text-red-600'} font-extrabold text-xl sm:text-2xl`}>{part}</span> 
                        : part
                    );
                };

                const theme = isDarkMode ? {
                    bg: 'bg-gray-900', text: 'text-gray-100', headerText: 'text-indigo-400',
                    cardFrontBg: 'bg-gray-800', cardFrontText: 'text-white', cardBorder: 'border-gray-700',
                    cardBackBg: 'bg-indigo-900', controlsBg: 'bg-gray-800', controlsBorder: 'border-gray-700',
                    selectText: 'text-indigo-300', subText: 'text-gray-400', counterBg: 'bg-gray-800',
                    counterText: 'text-gray-300', buttonBg: 'bg-gray-800', buttonHover: 'hover:bg-gray-700',
                    buttonText: 'text-gray-200', accent: 'bg-indigo-800 text-indigo-200'
                } : {
                    bg: 'bg-gradient-to-br from-blue-50 to-indigo-100', text: 'text-gray-800', headerText: 'text-indigo-700',
                    cardFrontBg: 'bg-white', cardFrontText: 'text-gray-800', cardBorder: 'border-indigo-200',
                    cardBackBg: 'bg-indigo-600', controlsBg: 'bg-white', controlsBorder: 'border-indigo-200',
                    selectText: 'text-indigo-700', subText: 'text-gray-500', counterBg: 'bg-white/50',
                    counterText: 'text-indigo-800', buttonBg: 'bg-white', buttonHover: 'hover:bg-gray-50',
                    buttonText: 'text-gray-700', accent: 'bg-indigo-100 text-indigo-500'
                };

                if (loading) {
                    return <div className={`h-[100dvh] flex flex-col items-center justify-center p-4 ${theme.bg} ${theme.text}`}><div className="text-4xl mb-4 animate-spin text-indigo-500"><Icon path={iconPaths.layers} size={48} /></div><div className="text-lg font-semibold">Wczytywanie bazy słów...</div></div>;
                }
                
                if (fileError) {
                    return <div className={`h-[100dvh] flex flex-col items-center justify-center p-8 ${theme.bg} ${theme.text} text-center`}>
                        <div className="text-4xl mb-4">⚠️</div>
                        <div className="text-xl font-bold mb-4 text-red-500">Problem z bazą danych</div>
                        <pre className="mb-6 text-sm bg-red-50 p-4 rounded text-left overflow-auto max-w-full whitespace-pre-wrap">{fileError}</pre>
                        <button onClick={() => location.reload()} className="bg-red-600 text-white px-6 py-2 rounded-lg">Odśwież stronę</button>
                    </div>;
                }

                return (
                    <div className={`h-[100dvh] flex flex-col items-center pt-4 pb-[5dvh] px-4 font-sans transition-colors-all duration-300 ${theme.bg} ${theme.text} relative overflow-hidden noselect`}>
                        
                        <header className="w-full max-w-lg flex-none flex flex-col items-center space-y-3 mt-2 mb-2">
                            <div className="w-full relative flex items-center justify-center min-h-[48px]">
                                <div className="absolute left-0">
                                    <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full shadow-md transition-all duration-300 ${isDarkMode ? 'bg-gray-800 text-yellow-400 hover:bg-gray-700' : 'bg-white text-indigo-600 hover:bg-gray-50'}`}>
                                        <Icon path={isDarkMode ? iconPaths.sun : iconPaths.moon} size={20} className="sm:w-6 sm:h-6" />
                                    </button>
                                </div>
                                
                                <h1 className={`text-xl sm:text-3xl font-extrabold flex items-center gap-2 ${theme.headerText} text-center`}>
                                    <Icon path={iconPaths.layers} size={24} className="sm:w-8 sm:h-8" /> Fiszki WOJTUKIEWICZ
                                </h1>
                            </div>
                            
                            <div className="w-full grid grid-cols-2 gap-2 sm:gap-3">
                                <div className={`${theme.controlsBg} px-3 py-2 rounded-xl shadow-md flex flex-col justify-center transition-colors-all duration-300`}>
                                    <label className={`text-[10px] sm:text-xs font-bold uppercase block mb-0.5 sm:mb-1 ${theme.subText}`}>Poziom</label>
                                    <select value={level} onChange={(e) => setLevel(e.target.value)} className={`w-full bg-transparent font-bold text-sm sm:text-base outline-none ${theme.selectText}`}>
                                        <option value="A1" className={isDarkMode ? "bg-gray-800 text-white" : "bg-white text-gray-900"}>A1</option>
                                        <option value="A2" className={isDarkMode ? "bg-gray-800 text-white" : "bg-white text-gray-900"}>A2</option>
                                        <option value="B1" className={isDarkMode ? "bg-gray-800 text-white" : "bg-white text-gray-900"}>B1</option>
                                        <option value="B2" className={isDarkMode ? "bg-gray-800 text-white" : "bg-white text-gray-900"}>B2</option>
                                    </select>
                                </div>
                                <div className={`${theme.controlsBg} px-3 py-2 rounded-xl shadow-md border-l-4 ${isDarkMode ? 'border-indigo-600' : 'border-indigo-400'} flex flex-col justify-center transition-colors-all duration-300`}>
                                    <label className={`text-[10px] sm:text-xs font-bold uppercase mb-0.5 sm:mb-1 flex items-center gap-1 ${theme.subText}`}><Icon path={iconPaths.tag} size={10} className="sm:w-3 sm:h-3"/> Temat</label>
                                    <select value={category} onChange={(e) => setCategory(e.target.value)} className={`w-full bg-transparent font-bold text-sm sm:text-base outline-none ${theme.selectText}`}>
                                        <option value="all" className={isDarkMode ? "bg-gray-800 text-white" : "bg-white text-gray-900"}>Wszystkie (Cały poziom)</option>
                                        {availableCategories.map(cat => <option key={cat} value={cat} className={isDarkMode ? "bg-gray-800 text-white" : "bg-white text-gray-900"}>{cat}</option>)}
                                    </select>
                                </div>
                            </div>

                            <div className={`${theme.counterBg} px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl text-xs sm:text-sm border border-white/10 font-semibold whitespace-nowrap ${theme.counterText} transition-colors-all duration-300 w-full sm:w-auto text-center mt-2`}>
                                {currentWordIds.length > 0 ? `${isFinished ? currentWordIds.length : currentIndex + 1} / ${currentWordIds.length}` : '0 / 0'}
                            </div>
                        </header>

                        {isFinished ? (
                             <div className="w-full max-w-md flex-1 min-h-[250px] mb-4 z-10 flex flex-col items-center justify-center animate-popIn">
                                <div className={`w-full p-8 rounded-3xl shadow-2xl flex flex-col items-center justify-center text-center ${theme.cardFrontBg} ${isDarkMode ? 'border border-gray-700' : ''}`}>
                                    <div className={`mb-6 p-6 rounded-full ${isDarkMode ? 'bg-yellow-500/20' : 'bg-yellow-100'}`}>
                                        <Icon path={iconPaths.trophy} size={64} className="text-yellow-500" />
                                    </div>
                                    <h2 className={`text-3xl font-black mb-2 ${theme.cardFrontText}`}>Gratulacje!</h2>
                                    <p className={`text-lg mb-8 ${theme.subText}`}>Brawo, skończyłeś całą kategorię!</p>
                                    
                                    <button onClick={handleReset} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg active:scale-95 transition-all text-lg flex items-center gap-2">
                                        <Icon path={iconPaths.rotate} size={24} /> Zacznij od nowa
                                    </button>
                                </div>
                             </div>
                        ) : (
                            <>
                                <div className="relative w-full max-w-md flex-1 min-h-[250px] mb-4 z-10 perspective-1000">
                                    <div 
                                        className={`relative w-full h-full shadow-2xl rounded-2xl cursor-pointer transform-style-3d ${noTransition ? '' : 'transition-transform duration-700 ease-in-out'}`}
                                        style={{ transform: `rotateY(${rotation}deg)` }}
                                        onClick={handleCardClick}
                                        onTouchStart={onTouchStart}
                                        onTouchMove={onTouchMove}
                                        onTouchEnd={onTouchEnd}
                                        onMouseDown={onMouseDown}
                                        onMouseMove={onMouseMove}
                                        onMouseUp={onMouseUp}
                                        onMouseLeave={onMouseLeave}
                                    >
                                        <div className={`absolute inset-0 w-full h-full rounded-2xl flex flex-col items-center justify-center p-4 sm:p-6 backface-hidden border-b-4 ${theme.cardFrontBg} ${isDarkMode ? 'border-gray-600' : 'border-indigo-200'} transition-colors-all duration-300`} style={{ transform: 'rotateY(0deg)' }}>
                                            {cardSide === 3 ? (
                                                <div className="w-full h-full flex flex-col animate-fadeIn">
                                                    <div className="flex justify-between items-center mb-2 sm:mb-3 border-b pb-2 border-gray-200/20 flex-none relative">
                                                        <h3 className={`font-bold flex items-center gap-2 text-sm sm:text-base ${isDarkMode ? 'text-indigo-300' : 'text-indigo-600'}`}>
                                                            <Icon path={iconPaths.book} size={16} className="sm:w-[18px] sm:h-[18px]"/> Zdania
                                                        </h3>
                                                        
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); setViewAllSentences(!viewAllSentences); }}
                                                            className={`mx-auto animate-spin-three p-1 rounded-full hover:bg-black/5 active:scale-95 transition-transform ${viewAllSentences ? 'text-emerald-500 bg-emerald-100/50' : 'text-indigo-400'}`}
                                                            title={viewAllSentences ? "Pokaż tylko dla tego słowa" : "Wczytaj wszystkie zdania z tej kategorii"}
                                                        >
                                                            <Icon path={iconPaths.reloadCustom} size={20} className="sm:w-6 sm:h-6" />
                                                        </button>

                                                        <div className="flex items-center gap-2" onClick={(e) => e.stopPropagation()}>
                                                            <div className={`px-2 py-1 rounded-lg border flex items-center gap-1 ${isDarkMode ? "bg-gray-700 border-gray-600" : "bg-gray-100 border-gray-300"}`}>
                                                                <Icon path={iconPaths.clock} size={12} className={isDarkMode ? "text-gray-400" : "text-indigo-500"}/>
                                                                <select 
                                                                    value={tense} 
                                                                    onChange={(e) => setTense(e.target.value)} 
                                                                    className={`bg-transparent text-xs font-bold outline-none w-[100px] sm:w-[120px] ${isDarkMode ? 'text-gray-200' : 'text-gray-800'}`}
                                                                >
                                                                    <option value="Base" className={isDarkMode ? "bg-gray-700 text-white" : "bg-white text-gray-900"}>Wybierz czas</option>
                                                                    {availableTenses.map(t => (
                                                                        <option key={t} value={t} className={isDarkMode ? "bg-gray-700 text-white" : "bg-white text-gray-900"}>{t}</option>
                                                                    ))}
                                                                    <option value="mixed" className={isDarkMode ? "bg-gray-700 text-white" : "bg-white text-gray-900"}>Mix czasów</option>
                                                                </select>
                                                            </div>
                                                            <button onClick={showTranslation} className="p-1 rounded-full hover:bg-gray-200/20" aria-label="Zamknij">
                                                                <Icon path={iconPaths.close} size={18} className={isDarkMode ? "text-gray-400" : "text-gray-500"} />
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <ul className="space-y-3 sm:space-y-4 text-base sm:text-lg text-left overflow-y-auto pr-1 custom-scrollbar flex-1">
                                                        {sentencesListToRender.length > 0 ? sentencesListToRender.map((s, i) => (
                                                            <li key={i} className="flex flex-col gap-1">
                                                                <div className="flex gap-2 leading-snug">
                                                                    <span className={isDarkMode ? 'text-gray-200' : 'text-gray-700'}>
                                                                        {highlightTargetWord(s.en, viewAllSentences ? s.word : displayData.word)}
                                                                    </span>
                                                                </div>
                                                                <div className={`pl-6 text-sm sm:text-base italic ${theme.subText}`}>({s.pl})</div>
                                                            </li>
                                                        )) : <li className="text-center opacity-50 italic mt-4">Brak przykładowych zdań dla tego czasu</li>}
                                                    </ul>
                                                    <div className={`mt-2 text-[10px] text-center italic opacity-60 ${theme.subText}`}>
                                                        {viewAllSentences ? "Widok wszystkich zdań z kategorii" : "Kliknij tło, aby wrócić"}
                                                    </div>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className={`absolute top-4 left-4 sm:top-6 sm:left-6 text-[10px] sm:text-xs font-bold uppercase flex flex-wrap items-center gap-1 sm:gap-2 max-w-full overflow-hidden ${theme.subText}`}>
                                                        <span className="truncate max-w-[80px] sm:max-w-none">{tense === 'mixed' ? 'Mix' : (tense === 'Base' ? 'Słowo En.' : tense)}</span>
                                                    </div>
                                                    <div className="flex-1 flex items-center justify-center w-full px-2">
                                                        <h2 className={`${getWordSizeClass(displayData.word)} font-black text-center break-words leading-tight ${theme.cardFrontText}`}>
                                                            {displayData.word}
                                                        </h2>
                                                    </div>
                                                    <div className={`absolute bottom-4 sm:bottom-6 text-[10px] sm:text-xs flex items-center gap-1 sm:gap-2 font-medium ${theme.subText}`}>
                                                        <Icon path={iconPaths.rotate} size={12} className="sm:w-[14px] sm:h-[14px]"/> Kliknij, aby obrócić
                                                    </div>
                                                </>
                                            )}
                                        </div>

                                        <div className={`absolute inset-0 w-full h-full text-white rounded-2xl flex flex-col items-center justify-center p-4 sm:p-6 backface-hidden border-b-4 ${theme.cardBackBg} ${isDarkMode ? 'border-indigo-950' : 'border-indigo-800'} transition-colors-all duration-300`} style={{ transform: 'rotateY(180deg)' }}>
                                            <div className="absolute top-4 right-4 sm:top-6 sm:right-6 text-[10px] sm:text-xs font-bold text-indigo-200 uppercase">Tłumaczenie</div>
                                            
                                            <h2 className={`${getTranslationSizeClass(displayData.translation)} font-bold mb-3 sm:mb-4 text-center leading-tight break-words max-w-full`}>
                                                {displayData.translation}
                                            </h2>
                                            
                                            <div className={`bg-white/20 px-5 sm:px-7 py-2 sm:py-3 rounded-full font-mono ${getPhoneticSizeClass(displayData.phonetic)} mb-8 sm:mb-10`}>
                                                {displayData.phonetic}
                                            </div>
                                            
                                            <button onClick={showSentences} className={`font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-xl shadow-lg active:scale-95 flex items-center gap-2 text-sm sm:text-base transition-colors ${isDarkMode ? 'bg-gray-800 text-white hover:bg-gray-700' : 'bg-white text-indigo-700 hover:bg-indigo-50'}`}>
                                                <Icon path={iconPaths.book} size={18} className="sm:w-5 sm:h-5"/> 
                                                {tense === 'Base' ? 'Zdania (Base)' : `Zdania (${tense})`}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="w-full max-w-md flex-none space-y-3 z-20 mb-2">
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={handlePrev} className={`${theme.buttonBg} ${theme.buttonHover} ${theme.buttonText} font-bold py-4 rounded-xl shadow-sm border ${theme.controlsBorder} flex justify-center gap-2 active:scale-95 transition-colors-all duration-300 text-sm`}>
                                            <Icon path={iconPaths.left} className="w-5 h-5" /> Poprzednia
                                        </button>
                                        <button onClick={handleNext} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center gap-2 active:scale-95 transition-colors duration-300 text-sm">
                                            Następna <Icon path={iconPaths.right} className="w-5 h-5" />
                                        </button>
                                    </div>
                                    <button onClick={handleSpeak} disabled={isSpeaking} className={`w-full text-lg font-bold py-4 rounded-xl shadow-xl active:scale-95 flex justify-center gap-3 border-b-4 transition-colors duration-300 ${isSpeaking ? "bg-emerald-400 border-emerald-600" : "bg-emerald-500 hover:bg-emerald-600 border-emerald-700 text-white"}`}>
                                        {isSpeaking ? <Icon path={iconPaths.volX} size={24} className="sm:w-6 sm:h-6"/> : <Icon path={iconPaths.vol} size={24} className="sm:w-6 sm:h-6"/>}
                                        {isSpeaking ? "Odtwarzanie..." : (cardSide === 3 ? "Czytaj zdania" : "Czytaj wymowę")}
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<FlashcardsApp />);
        } catch (err) {
            document.getElementById('error-overlay').style.display = 'flex';
            document.getElementById('error-message').textContent = err.toString();
        }
    </script>
</body>
</html>


